!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Kookit={})}(this,function(e){"use strict";function p(e,o,a,l){return new(a=a||Promise)(function(r,t){function i(e){try{s(l.next(e))}catch(e){t(e)}}function n(e){try{s(l.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,n)}s((l=l.apply(e,o||[])).next())})}let i=["章","节","回","節","卷","部","輯","辑","話","集","话","篇"];String.prototype.contains=function(e){return-1<this.indexOf(e)};const a=e=>Array.from(e.querySelectorAll("h1,h2,h3,h4,h5,h6,title")),d=e=>Array.from(e.querySelectorAll("h1,h2,h3,h4,h5,h6,p,div,ul,dl,ol,pre,blockquote,address")),f=e=>e.trim().replace(/(\r\n|\n|\r)/gm,"").substring(0,100),o=e=>{var t=(new DOMParser).parseFromString(e,"text/html");let r=Array.from(t.querySelectorAll("img"));if(0===r.length)return e;for(let e=0;e<r.length;e++){var i=document.createElement("address"),n=document.createTextNode("img");i.appendChild(n),i.setAttribute("style","visibility: hidden; position: absolute"),r[e].parentNode&&r[e].parentNode.insertBefore(i,r[e])}return t.documentElement.innerHTML},l=(e,t=!1)=>e&&!e.contains("[")&&!e.contains("(")&&!e.contains("。")&&!e.contains("“")&&!e.contains("‘")&&!e.contains("；")&&!e.contains(";")&&(e.startsWith("CHAPTER")||e.startsWith("Chapter")||e.startsWith("序章")||e.startsWith("前言")||e.startsWith("声明")||e.startsWith("聲明")||e.startsWith("写在前面的话")||e.startsWith("后记")||e.startsWith("楔子")||e.startsWith("后序")||e.startsWith("寫在前面的話")||e.startsWith("後記")||e.startsWith("後序")||e.startsWith("第")&&r(e)||e.startsWith("卷")&&n(e)||!t&&e.contains("第")&&(" "===e[e.indexOf("第")-1]||"　"===e[e.indexOf("第")-1]||"、"===e[e.indexOf("第")-1]||"："===e[e.indexOf("第")-1]||":"===e[e.indexOf("第")-1])&&r(e.substr(e.indexOf("第")))||!t&&e.indexOf(" ")&&s(e)||!t&&e.indexOf("　")&&s(e)||!t&&e.indexOf("、")&&h(e)||!t&&e.indexOf("：")&&c(e)||!t&&e.indexOf(":")&&c(e)),r=t=>{let r=!1;for(let e=0;e<i.length&&(!(-1<t.indexOf(i[e])&&(" "===t[t.indexOf(i[e])+1]||"　"===t[t.indexOf(i[e])+1]||"、"===t[t.indexOf(i[e])+1]||"："===t[t.indexOf(i[e])+1]||-1<t.indexOf("章")||":"===t[t.indexOf(i[e])+1]))&&t[t.indexOf(i[e])+1]||((/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(t.substring(1,t.indexOf(i[e])).trim())||/^\d+$/.test(t.substring(1,t.indexOf(i[e])).trim()))&&(r=!0),!r));e++);return r},n=e=>!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf(" ")))&&!/^\d+$/.test(e.substring(1,e.indexOf(" "))))||(!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf("　")))&&!/^\d+$/.test(e.substring(1,e.indexOf("　"))))||!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1))&&!/^\d+$/.test(e.substring(1)))),s=e=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(0,e.indexOf(" ")))||(!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(0,e.indexOf("　")))||(!!/^\d+$/.test(e.substring(0,e.indexOf(" ")))||!!/^\d+$/.test(e.substring(0,e.indexOf("　"))))),c=e=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(0,e.indexOf(":")))||(!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(0,e.indexOf("：")))||(!!/^\d+$/.test(e.substring(0,e.indexOf(":")))||!!/^\d+$/.test(e.substring(0,e.indexOf("："))))),h=e=>!!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(0,e.indexOf("、")))||!!/^\d+$/.test(e.substring(0,e.indexOf("、"))),u=e=>"♦"===e.trim()||"●"===e.trim()||"◾"===e.trim()||"◀"===e.trim()||"◼"===e.trim()||"■"===e.trim(),m=e=>"|"===e.trim()||"Next"===e.trim()||"Main menu"===e.trim()||"Section menu"===e.trim()||"Previous"===e.trim();window.a=window.atob,String.prototype.slim=function(){return this.split("").filter(e=>"="!==e&&"-"!==e&&"_"!==e&&"+"!==e).join("")};const g=e=>{let t="",r=!1;var i;for(i of e.split("\n"))i.trim().slim()&&(l(i.trim().slim(),r)?((i.trim().slim().startsWith("第")||i.trim().slim().startsWith("Chapter")||i.trim().slim().startsWith("CHAPTER"))&&(r=!0),t+=`<h1>${i}</h1>`):t+=`<p>${i}</p>`);return t||`<h1>Title</h1><p>${e}</p>`},b=(e,t="")=>{var r=document.createElement("iframe");if(r.style.width="100%",r.style.border="0",r.style.margin="0",r.style.padding="0",r.style.fontSize="100%",r.style.font="inherit",r.style.verticalAlign="baseline",e.innerHTML="",e.appendChild(r),t&&r.contentDocument){let e=r.contentDocument.createElement("style");e.id="azw3-style",e.textContent=t,r.contentDocument.head.appendChild(e)}},y=(r,i)=>{let e=document.getElementById("page-area");if(e){var n=e.getElementsByTagName("iframe")[0];if(n){let t=n.contentDocument;if(t){let e=t.createElement("style");e.id="default-style",e.textContent="p,empty-line{display: inherit;margin-block-start: inherit;margin-block-end: inherit;margin-inline-start: inherit;margin-inline-end: inherit;}body{margin: 0px}",t.head.appendChild(e),"scroll"!==i&&(n="double"===i?2:1,i=(i=Math.floor(r.clientWidth/12))%2==0?i:i-1,t.body.setAttribute("style",`width: auto;height: 100%;overflow-y: hidden;overflow-X: hidden;padding-left: 0px;padding-right: 0px;margin: 0px;box-sizing: border-box;max-width: inherit;column-fill: auto;column-gap: ${i}px;column-count: 12;column-width: ${(r.offsetWidth-i)/n}px;`))}}}};class t{constructor(e){this.bookStr=e,this.chapterList=[],this.chapterDocList=[]}getChapterDoc(){var t=this.bookStr.split("<address> </address>").filter(e=>""!==e.trim()).map(e=>o(e));let i=[],n=[],r="";for(let e=0;e<t.length;e++)(e=>{let t=a(e);var r=0<t.length;let i=e.getElementsByTagName("p"),n;for(let e=0;e<t.length;e++){var s=n&&u(t[e].innerText)&&m(t[e].innerText);if(t[e].innerText.trim()&&!s){n=t[e];break}}for(let e=0;e<i.length&&(!i[e].innerText.trim()||-1!==i[e].innerHTML.indexOf("<"));e++);var o=n&&30<n.innerText.trim().length,e=50<e.body.innerText.length;return r&&(!o||l(n.innerText.trim()))&&e})((new DOMParser).parseFromString(t[e],"text/html"))?(i.push(r+t[e]),r=""):r+=t[e];0===i.length&&i.push(r);for(let e=0;e<i.length;e++){var s=(new DOMParser).parseFromString(i[e],"text/html");let t=a(s),r;for(let e=0;e<t.length;e++)if(t[e].innerText.trim()&&!u(t[e].innerText)&&!m(t[e].innerText)){r=t[e];break}this.chapterDocList.push({title:r?r.innerText:"",text:i[e]}),r&&n.push(r.innerText)}return this.chapterDocList}getChapter(){for(let e=0;e<this.chapterDocList.length;e++)this.chapterDocList[e].title&&this.chapterList.push({title:this.chapterDocList[e].title,id:"title"+e,href:"title"+e,index:e,subitems:[]});return this.chapterList}}class v{constructor(e){this.bookStr=e,this.chapterList=[],this.chapterDocList=[],this.bookDoc=(new DOMParser).parseFromString(this.bookStr,"text/html"),this.chapterDomList=[]}getChapter(){this.chapterDomList=a(this.bookDoc),this.insertPageBreak();let e=new t(this.bookDoc.body.innerHTML);return this.chapterDocList=e.getChapterDoc(),this.chapterList=e.getChapter(),this.chapterList}getDocText(){return this.bookDoc.body.textContent||""}isContainChapter(){return this.chapterDomList=a(this.bookDoc),0<this.chapterDomList.length}insertPageBreak(){for(let e=0;e<this.chapterDomList.length;e++){var t=document.createElement("address"),r=document.createTextNode(" ");t.appendChild(r),this.chapterDomList[e].parentNode&&this.chapterDomList[e].parentNode.insertBefore(t,this.chapterDomList[e])}}getChapterDoc(){return this.chapterDocList}}class w{static getReaderConfig(e){return(JSON.parse(localStorage.getItem("readerConfig"))||{})[e]}static setReaderConfig(e,t){let r=JSON.parse(localStorage.getItem("readerConfig"))||{};r[e]=t,localStorage.setItem("readerConfig",JSON.stringify(r))}static getKookitConfig(e){return(JSON.parse(localStorage.getItem("kookitConfig"))||{})[e]}static setKookitConfig(e,t){let r=JSON.parse(localStorage.getItem("kookitConfig"))||{};r[e]=t,localStorage.setItem("kookitConfig",JSON.stringify(r))}static removeKookitConfig(){localStorage.removeItem("kookitConfig")}}var x={S:"万与丑专业丛东丝丢两严丧个丬丰临为丽举么义乌乐乔习乡书买乱争于亏云亘亚产亩亲亵亸亿仅从仑仓仪们价众优伙会伛伞伟传伤伥伦伧伪伫体余佣佥侠侣侥侦侧侨侩侪侬俣俦俨俩俪俭债倾偬偻偾偿傥傧储傩儿兑兖党兰关兴兹养兽冁内冈册写军农冢冯冲决况冻净凄凉凌减凑凛几凤凫凭凯击凼凿刍划刘则刚创删别刬刭刽刿剀剂剐剑剥剧劝办务劢动励劲劳势勋勐勚匀匦匮区医华协单卖卢卤卧卫却卺厂厅历厉压厌厍厕厢厣厦厨厩厮县参叆叇双发变叙叠叶号叹叽吁后吓吕吗吣吨听启吴呒呓呕呖呗员呙呛呜咏咔咙咛咝咤咴咸哌响哑哒哓哔哕哗哙哜哝哟唛唝唠唡唢唣唤唿啧啬啭啮啰啴啸喷喽喾嗫呵嗳嘘嘤嘱噜噼嚣嚯团园囱围囵国图圆圣圹场坂坏块坚坛坜坝坞坟坠垄垅垆垒垦垧垩垫垭垯垱垲垴埘埙埚埝埯堑堕塆墙壮声壳壶壸处备复够头夸夹夺奁奂奋奖奥妆妇妈妩妪妫姗姜娄娅娆娇娈娱娲娴婳婴婵婶媪嫒嫔嫱嬷孙学孪宁宝实宠审宪宫宽宾寝对寻导寿将尔尘尧尴尸尽层屃屉届属屡屦屿岁岂岖岗岘岙岚岛岭岳岽岿峃峄峡峣峤峥峦崂崃崄崭嵘嵚嵛嵝嵴巅巩巯币帅师帏帐帘帜带帧帮帱帻帼幂幞干并广庄庆庐庑库应庙庞废庼廪开异弃张弥弪弯弹强归当录彟彦彻径徕御忆忏忧忾怀态怂怃怄怅怆怜总怼怿恋恳恶恸恹恺恻恼恽悦悫悬悭悯惊惧惨惩惫惬惭惮惯愍愠愤愦愿慑慭憷懑懒懔戆戋戏戗战戬户扎扑扦执扩扪扫扬扰抚抛抟抠抡抢护报担拟拢拣拥拦拧拨择挂挚挛挜挝挞挟挠挡挢挣挤挥挦捞损捡换捣据捻掳掴掷掸掺掼揸揽揿搀搁搂搅携摄摅摆摇摈摊撄撑撵撷撸撺擞攒敌敛数斋斓斗斩断无旧时旷旸昙昼昽显晋晒晓晔晕晖暂暧札术朴机杀杂权条来杨杩杰极构枞枢枣枥枧枨枪枫枭柜柠柽栀栅标栈栉栊栋栌栎栏树栖样栾桊桠桡桢档桤桥桦桧桨桩梦梼梾检棂椁椟椠椤椭楼榄榇榈榉槚槛槟槠横樯樱橥橱橹橼檐檩欢欤欧歼殁殇残殒殓殚殡殴毁毂毕毙毡毵氇气氢氩氲汇汉污汤汹沓沟没沣沤沥沦沧沨沩沪沵泞泪泶泷泸泺泻泼泽泾洁洒洼浃浅浆浇浈浉浊测浍济浏浐浑浒浓浔浕涂涌涛涝涞涟涠涡涢涣涤润涧涨涩淀渊渌渍渎渐渑渔渖渗温游湾湿溃溅溆溇滗滚滞滟滠满滢滤滥滦滨滩滪漤潆潇潋潍潜潴澜濑濒灏灭灯灵灾灿炀炉炖炜炝点炼炽烁烂烃烛烟烦烧烨烩烫烬热焕焖焘煅煳熘爱爷牍牦牵牺犊犟状犷犸犹狈狍狝狞独狭狮狯狰狱狲猃猎猕猡猪猫猬献獭玑玙玚玛玮环现玱玺珉珏珐珑珰珲琎琏琐琼瑶瑷璇璎瓒瓮瓯电画畅畲畴疖疗疟疠疡疬疮疯疱疴痈痉痒痖痨痪痫痴瘅瘆瘗瘘瘪瘫瘾瘿癞癣癫癯皑皱皲盏盐监盖盗盘眍眦眬着睁睐睑瞒瞩矫矶矾矿砀码砖砗砚砜砺砻砾础硁硅硕硖硗硙硚确硷碍碛碜碱碹磙礼祎祢祯祷祸禀禄禅离秃秆种积称秽秾稆税稣稳穑穷窃窍窑窜窝窥窦窭竖竞笃笋笔笕笺笼笾筑筚筛筜筝筹签简箓箦箧箨箩箪箫篑篓篮篱簖籁籴类籼粜粝粤粪粮糁糇紧絷纟纠纡红纣纤纥约级纨纩纪纫纬纭纮纯纰纱纲纳纴纵纶纷纸纹纺纻纼纽纾线绀绁绂练组绅细织终绉绊绋绌绍绎经绐绑绒结绔绕绖绗绘给绚绛络绝绞统绠绡绢绣绤绥绦继绨绩绪绫绬续绮绯绰绱绲绳维绵绶绷绸绹绺绻综绽绾绿缀缁缂缃缄缅缆缇缈缉缊缋缌缍缎缏缐缑缒缓缔缕编缗缘缙缚缛缜缝缞缟缠缡缢缣缤缥缦缧缨缩缪缫缬缭缮缯缰缱缲缳缴缵罂网罗罚罢罴羁羟羡翘翙翚耢耧耸耻聂聋职聍联聩聪肃肠肤肷肾肿胀胁胆胜胧胨胪胫胶脉脍脏脐脑脓脔脚脱脶脸腊腌腘腭腻腼腽腾膑臜舆舣舰舱舻艰艳艹艺节芈芗芜芦苁苇苈苋苌苍苎苏苘苹茎茏茑茔茕茧荆荐荙荚荛荜荞荟荠荡荣荤荥荦荧荨荩荪荫荬荭荮药莅莜莱莲莳莴莶获莸莹莺莼萚萝萤营萦萧萨葱蒇蒉蒋蒌蓝蓟蓠蓣蓥蓦蔷蔹蔺蔼蕲蕴薮藁藓虏虑虚虫虬虮虽虾虿蚀蚁蚂蚕蚝蚬蛊蛎蛏蛮蛰蛱蛲蛳蛴蜕蜗蜡蝇蝈蝉蝎蝼蝾螀螨蟏衅衔补衬衮袄袅袆袜袭袯装裆裈裢裣裤裥褛褴襁襕见观觃规觅视觇览觉觊觋觌觍觎觏觐觑觞触觯詟誉誊讠计订讣认讥讦讧讨让讪讫训议讯记讱讲讳讴讵讶讷许讹论讻讼讽设访诀证诂诃评诅识诇诈诉诊诋诌词诎诏诐译诒诓诔试诖诗诘诙诚诛诜话诞诟诠诡询诣诤该详诧诨诩诪诫诬语诮误诰诱诲诳说诵诶请诸诹诺读诼诽课诿谀谁谂调谄谅谆谇谈谊谋谌谍谎谏谐谑谒谓谔谕谖谗谘谙谚谛谜谝谞谟谠谡谢谣谤谥谦谧谨谩谪谫谬谭谮谯谰谱谲谳谴谵谶谷豮贝贞负贠贡财责贤败账货质贩贪贫贬购贮贯贰贱贲贳贴贵贶贷贸费贺贻贼贽贾贿赀赁赂赃资赅赆赇赈赉赊赋赌赍赎赏赐赑赒赓赔赕赖赗赘赙赚赛赜赝赞赟赠赡赢赣赪赵赶趋趱趸跃跄跖跞践跶跷跸跹跻踊踌踪踬踯蹑蹒蹰蹿躏躜躯车轧轨轩轪轫转轭轮软轰轱轲轳轴轵轶轷轸轹轺轻轼载轾轿辀辁辂较辄辅辆辇辈辉辊辋辌辍辎辏辐辑辒输辔辕辖辗辘辙辚辞辩辫边辽达迁过迈运还这进远违连迟迩迳迹适选逊递逦逻遗遥邓邝邬邮邹邺邻郁郄郏郐郑郓郦郧郸酝酦酱酽酾酿释里鉅鉴銮錾钆钇针钉钊钋钌钍钎钏钐钑钒钓钔钕钖钗钘钙钚钛钝钞钟钠钡钢钣钤钥钦钧钨钩钪钫钬钭钮钯钰钱钲钳钴钵钶钷钸钹钺钻钼钽钾钿铀铁铂铃铄铅铆铈铉铊铋铍铎铏铐铑铒铕铗铘铙铚铛铜铝铞铟铠铡铢铣铤铥铦铧铨铪铫铬铭铮铯铰铱铲铳铴铵银铷铸铹铺铻铼铽链铿销锁锂锃锄锅锆锇锈锉锊锋锌锍锎锏锐锑锒锓锔锕锖锗错锚锜锞锟锠锡锢锣锤锥锦锨锩锫锬锭键锯锰锱锲锳锴锵锶锷锸锹锺锻锼锽锾锿镀镁镂镃镆镇镈镉镊镌镍镎镏镐镑镒镕镖镗镙镚镛镜镝镞镟镠镡镢镣镤镥镦镧镨镩镪镫镬镭镮镯镰镱镲镳镴镶长门闩闪闫闬闭问闯闰闱闲闳间闵闶闷闸闹闺闻闼闽闾闿阀阁阂阃阄阅阆阇阈阉阊阋阌阍阎阏阐阑阒阓阔阕阖阗阘阙阚阛队阳阴阵阶际陆陇陈陉陕陧陨险随隐隶隽难雏雠雳雾霁霉霭靓静靥鞑鞒鞯鞴韦韧韨韩韪韫韬韵页顶顷顸项顺须顼顽顾顿颀颁颂颃预颅领颇颈颉颊颋颌颍颎颏颐频颒颓颔颕颖颗题颙颚颛颜额颞颟颠颡颢颣颤颥颦颧风飏飐飑飒飓飔飕飖飗飘飙飚飞飨餍饤饥饦饧饨饩饪饫饬饭饮饯饰饱饲饳饴饵饶饷饸饹饺饻饼饽饾饿馀馁馂馃馄馅馆馇馈馉馊馋馌馍馎馏馐馑馒馓馔馕马驭驮驯驰驱驲驳驴驵驶驷驸驹驺驻驼驽驾驿骀骁骂骃骄骅骆骇骈骉骊骋验骍骎骏骐骑骒骓骔骕骖骗骘骙骚骛骜骝骞骟骠骡骢骣骤骥骦骧髅髋髌鬓魇魉鱼鱽鱾鱿鲀鲁鲂鲄鲅鲆鲇鲈鲉鲊鲋鲌鲍鲎鲏鲐鲑鲒鲓鲔鲕鲖鲗鲘鲙鲚鲛鲜鲝鲞鲟鲠鲡鲢鲣鲤鲥鲦鲧鲨鲩鲪鲫鲬鲭鲮鲯鲰鲱鲲鲳鲴鲵鲶鲷鲸鲹鲺鲻鲼鲽鲾鲿鳀鳁鳂鳃鳄鳅鳆鳇鳈鳉鳊鳋鳌鳍鳎鳏鳐鳑鳒鳓鳔鳕鳖鳗鳘鳙鳛鳜鳝鳞鳟鳠鳡鳢鳣鸟鸠鸡鸢鸣鸤鸥鸦鸧鸨鸩鸪鸫鸬鸭鸮鸯鸰鸱鸲鸳鸴鸵鸶鸷鸸鸹鸺鸻鸼鸽鸾鸿鹀鹁鹂鹃鹄鹅鹆鹇鹈鹉鹊鹋鹌鹍鹎鹏鹐鹑鹒鹓鹔鹕鹖鹗鹘鹚鹛鹜鹝鹞鹟鹠鹡鹢鹣鹤鹥鹦鹧鹨鹩鹪鹫鹬鹭鹯鹰鹱鹲鹳鹴鹾麦麸黄黉黡黩黪黾鼋鼌鼍鼗鼹齄齐齑齿龀龁龂龃龄龅龆龇龈龉龊龋龌龙龚龛龟志制咨只里系范松没尝尝闹面准钟别闲乾尽脏拼",T:"萬與醜專業叢東絲丟兩嚴喪個爿豐臨為麗舉麽義烏樂喬習鄉書買亂爭於虧雲亙亞產畝親褻亸億僅從侖倉儀們價眾優夥會傴傘偉傳傷倀倫傖偽佇體余傭僉俠侶僥偵側僑儈儕儂俁儔儼倆儷儉債傾傯僂僨償儻儐儲儺兒兌兗黨蘭關興茲養獸囅內岡冊寫軍農冢馮沖決況凍凈淒涼淩減湊凜幾鳳鳧憑凱擊氹鑿芻劃劉則剛創刪別刬剄劊劌剴劑剮劍剝劇勸辦務勱動勵勁勞勢勛猛勚勻匭匱區醫華協單賣盧鹵臥衛卻巹廠廳歷厲壓厭厙廁廂厴廈廚廄廝縣參叆叇雙發變敘叠葉號嘆嘰籲後嚇呂嗎唚噸聽啟吳嘸囈嘔嚦唄員咼嗆嗚詠哢嚨嚀噝咤噅鹹哌響啞噠嘵嗶噦嘩噲嚌噥喲嘜唝嘮唡嗩唣喚唿嘖嗇囀嚙啰啴嘯噴嘍嚳囁呵噯噓嚶囑嚕劈囂謔團園囪圍圇國圖圓聖壙場阪壞塊堅壇壢壩塢墳墜壟壟壚壘墾坰堊墊埡垯垱塏堖塒塤堝墊垵塹墮塆墻壯聲殼壺壸處備復夠頭誇夾奪奩奐奮獎奧妝婦媽嫵嫗媯姍姜婁婭嬈嬌孌娛媧嫻婳嬰嬋嬸媼嬡嬪嬙嬤孫學孿寧寶實寵審憲宮寬賓寢對尋導壽將爾塵堯尷屍盡層屃屜屆屬屢屨嶼歲豈嶇崗峴嶴嵐島嶺嶽崠巋峃嶧峽峣嶠崢巒嶗崍崄嶄嶸嵚崳嶁脊巔鞏巰幣帥師幃帳簾幟帶幀幫幬幘幗冪襆幹並廣莊慶廬廡庫應廟龐廢庼廩開異棄張彌弳彎彈強歸當錄彟彥徹徑徠禦憶懺憂愾懷態慫憮慪悵愴憐總懟懌戀懇惡慟懨愷惻惱惲悅愨懸慳憫驚懼慘懲憊愜慚憚慣湣慍憤憒願懾慭怵懣懶懍戇戔戲戧戰戩戶紮撲扡執擴捫掃揚擾撫拋摶摳掄搶護報擔擬攏揀擁攔擰撥擇掛摯攣挜撾撻挾撓擋撟掙擠揮挦撈損撿換搗據撚擄摑擲撣摻摜摣攬撳攙擱摟攪攜攝攄擺搖擯攤攖撐攆擷擼攛擻攢敵斂數齋斕鬥斬斷無舊時曠旸曇晝昽顯晉曬曉曄暈暉暫曖劄術樸機殺雜權條來楊榪傑極構樅樞棗櫪梘棖槍楓梟櫃檸檉梔柵標棧櫛櫳棟櫨櫟欄樹棲樣欒棬椏橈楨檔榿橋樺檜槳樁夢梼梾檢欞槨櫝槧欏橢樓欖櫬櫚櫸槚檻檳櫧橫檣櫻櫫櫥櫓櫞檐檁歡歟歐殲歿殤殘殞殮殫殯毆毀轂畢斃氈毿氌氣氫氬氳匯漢汙湯洶沓溝沒灃漚瀝淪滄沨溈滬沵濘淚澩瀧瀘濼瀉潑澤涇潔灑窪浹淺漿澆湞浉濁測澮濟瀏浐渾滸濃潯浕塗湧濤澇淶漣潿渦涢渙滌潤澗漲澀澱淵淥漬瀆漸澠漁瀋滲溫遊灣濕潰濺漵溇潷滾滯灩灄滿瀅濾濫灤濱灘滪濫瀠瀟瀲濰潛瀦瀾瀨瀕灝滅燈靈災燦煬爐燉煒熗點煉熾爍爛烴燭煙煩燒燁燴燙燼熱煥燜燾煆糊溜愛爺牘牦牽犧犢犟狀獷獁猶狽麅狝獰獨狹獅獪猙獄猻獫獵獼玀豬貓猬獻獺璣玙玚瑪瑋環現玱璽瑉玨琺瓏珰琿琎璉瑣瓊瑤璦璇瓔瓚甕甌電畫暢畬疇癤療瘧癘瘍癧瘡瘋皰屙癰痙癢瘂癆瘓癇癡癉瘆瘞瘺癟癱癮癭癩癬癲臒皚皺皸盞鹽監蓋盜盤瞘眥眬著睜睞瞼瞞矚矯磯礬礦碭碼磚硨硯碸礪礱礫礎硁矽碩硤磽硙硚確鹼礙磧磣堿碹滾禮祎禰禎禱禍稟祿禪離禿稈種積稱穢秾穭稅穌穩穡窮竊竅窯竄窩窺竇窶豎競篤筍筆筧箋籠籩築篳篩筜箏籌簽簡箓簀篋籜籮簞簫簣簍籃籬籪籟糴類秈糶糲粵糞糧糝糇緊縶糸糾紆紅紂纖紇約級紈纊紀紉緯紜纮純紕紗綱納纴縱綸紛紙紋紡纻纼紐紓線紺紲紱練組紳細織終縐絆紼絀紹繹經紿綁絨結絝繞绖絎繪給絢絳絡絕絞統綆綃絹繡绤綏絳繼綈績緒綾绬續綺緋綽緔緄繩維綿綬繃綢绹綹綣綜綻綰綠綴緇緙緗緘緬纜緹緲緝缊繢緦綞緞緶缐緱縋緩締縷編緡緣縉縛縟縝縫缞縞纏縭縊縑繽縹縵縲纓縮繆繅纈繚繕繒韁繾繰繯繳纘罌網羅罰罷羆羈羥羨翹翙翚耮耬聳恥聶聾職聹聯聵聰肅腸膚膁腎腫脹脅膽勝朧腖臚脛膠脈膾臟臍腦膿臠腳脫腡臉臘腌腘腭膩靦膃騰臏臜輿艤艦艙艫艱艷艹藝節羋薌蕪蘆蓯葦藶莧萇蒼苧蘇檾蘋莖蘢蔦塋煢繭荊薦荙莢蕘蓽蕎薈薺蕩榮葷滎犖熒蕁藎蓀蔭蕒葒葤藥蒞蓧萊蓮蒔萵薟獲蕕瑩鶯蒓萚蘿螢營縈蕭薩蔥蕆蕢蔣蔞藍薊蘺蕷鎣驀薔蘞藺藹蘄蘊藪槁蘚虜慮虛蟲虬蟣雖蝦蠆蝕蟻螞蠶蠔蜆蠱蠣蟶蠻蟄蛺蟯螄蠐蛻蝸蠟蠅蟈蟬蠍螻蠑螀蟎蟏釁銜補襯袞襖裊袆襪襲袯裝襠裈褳襝褲襇褸襤繈襕見觀觃規覓視覘覽覺覬覡覿觍覦覯覲覷觴觸觶詟譽謄訁計訂訃認譏訐訌討讓訕訖訓議訊記讱講諱謳詎訝訥許訛論讻訟諷設訪訣證詁訶評詛識诇詐訴診詆謅詞詘詔诐譯詒誆誄試詿詩詰詼誠誅詵話誕詬詮詭詢詣諍該詳詫諢詡诪誡誣語誚誤誥誘誨誑說誦誒請諸諏諾讀諑誹課諉諛誰諗調諂諒諄誶談誼謀諶諜謊諫諧謔謁謂諤諭諼讒諮諳諺諦謎諞谞謨讜謖謝謠謗謚謙謐謹謾謫譾謬譚譖譙讕譜譎讞譴譫讖谷豮貝貞負贠貢財責賢敗賬貨質販貪貧貶購貯貫貳賤賁貰貼貴貺貸貿費賀貽賊贄賈賄貲賃賂贓資賅贐賕賑賚賒賦賭賫贖賞賜赑赒賡賠賧賴赗贅賻賺賽賾贗贊赟贈贍贏贛赪趙趕趨趲躉躍蹌跖躒踐跶蹺蹕躚躋踴躊蹤躓躑躡蹣躕躥躪躦軀車軋軌軒轪軔轉軛輪軟轟軲軻轤軸軹軼軤軫轢軺輕軾載輊轎辀輇輅較輒輔輛輦輩輝輥輞辌輟輜輳輻輯辒輸轡轅轄輾轆轍轔辭辯辮邊遼達遷過邁運還這進遠違連遲邇逕跡適選遜遞邐邏遺遙鄧鄺鄔郵鄒鄴鄰郁郤郟鄶鄭鄆酈鄖鄲醞酦醬釅釃釀釋裏鉅鑒鑾鏨釓釔針釘釗釙釕釷釬釧釤钑釩釣鍆釹钖釵钘鈣鈈鈦鈍鈔鐘鈉鋇鋼鈑鈐鑰欽鈞鎢鉤鈧鈁鈥鈄鈕鈀鈺錢鉦鉗鈷缽鈳鉕鈽鈸鉞鉆鉬鉭鉀鈿鈾鐵鉑鈴鑠鉛鉚鈰鉉鉈鉍鈹鐸铏銬銠鉺銪鋏鋣鐃铚鐺銅鋁銱銦鎧鍘銖銑鋌銩铦鏵銓鉿銚鉻銘錚銫鉸銥鏟銃鐋銨銀銣鑄鐒鋪铻錸鋱鏈鏗銷鎖鋰鋥鋤鍋鋯鋨銹銼鋝鋒鋅鋶鐦鐧銳銻鋃鋟鋦錒錆鍺錯錨锜錁錕锠錫錮鑼錘錐錦鍁錈錇錟錠鍵鋸錳錙鍥锳鍇鏘鍶鍔鍤鍬鍾鍛鎪锽鍰鎄鍍鎂鏤镃鏌鎮镈鎘鑷鐫鎳鎿鎦鎬鎊鎰镕鏢鏜鏍镚鏞鏡鏑鏃鏇镠鐔鐝鐐鏷鑥鐓鑭鐠鑹鏹鐙鑊鐳镮鐲鐮鐿鑔鑣镴鑲長門閂閃閆闬閉問闖閏闈閑閎間閔閌悶閘鬧閨聞闥閩閭闿閥閣閡閫鬮閱閬阇閾閹閶鬩閿閽閻閼闡闌闃阓闊闋闔闐阘闕闞阛隊陽陰陣階際陸隴陳陘陜隉隕險隨隱隸雋難雛讎靂霧霽黴靄靚靜靨韃鞽韉韝韋韌韨韓韙韞韜韻頁頂頃頇項順須頊頑顧頓頎頒頌頏預顱領頗頸頡頰颋頜潁颎頦頤頻颒頹頷颕穎顆題颙顎顓顏額顳顢顛顙顥颣顫顬顰顴風飏飐颮颯颶飔颼飖飗飄飆飈飛饗饜饤饑饦餳飩餼飪飫飭飯飲餞飾飽飼饳飴餌饒餉饸饹餃饻餅餑饾餓餘餒馂馃餛餡館餷饋馉餿饞馌饃馎餾饈饉饅饊饌饢馬馭馱馴馳驅驲駁驢駔駛駟駙駒騶駐駝駑駕驛駘驍罵骃驕驊駱駭駢骉驪騁驗骍骎駿騏騎騍騅骔骕驂騙騭骙騷騖驁騮騫騸驃騾驄驏驟驥骦驤髏髖髕鬢魘魎魚鱽鱾魷鲀魯魴鲄鮁鮃鮎鱸鲉鲊鮒鲌鮑鱟鲏鮐鮭鮚鲓鮪鮞鲖鲗鲘鲙鱭鮫鮮鲝鯗鱘鯁鱺鰱鰹鯉鰣鰷鯀鯊鯇鲪鯽鲬鯖鯪鲯鯫鯡鯤鯧鯝鯢鯰鯛鯨鲹鯴鯔鱝鰈鲾鲿鳀鳁鳂鰓鱷鰍鰒鰉鳈鳉鯿鰠鰲鰭鰨鰥鰩鳑鳒鰳鰾鱈鱉鰻鰵鱅鳛鱖鱔鱗鱒鳠鳡鱧鳣鳥鳩雞鳶鳴鸤鷗鴉鸧鴇鴆鴣鶇鸕鴨鸮鴦鸰鴟鴝鴛鸴鴕鷥鷙鴯鴰鵂鸻鸼鴿鸞鴻鹀鵓鸝鵑鵠鵝鵒鷴鵜鵡鵲鶓鵪鹍鵯鵬鹐鶉鹒鹓鹔鶘鹖鶚鶻鶿鶥鶩鹝鷂鹟鹠鹡鹢鶼鶴鹥鸚鷓鷚鷯鷦鷲鷸鷺鹯鷹鸌鹲鸛鹴鹺麥麩黃黌黡黷黲黽黿鼌鼉鼗鼴齇齊齏齒齔龁龂齟齡齙齠齜齦齬齪齲齷龍龔龕龜誌制咨只裏系範松沒嘗嘗鬧面準鐘別閑乾盡臟拼"},T=x.S,C=x.T;function L(e,t){var r,i,n,s,o="",a=t?(s=T,C):(s=C,T);if("string"!=typeof e)return e;for(r=0;r<e.length;r++)i=e.charAt(r),13312<(n=e.charCodeAt(r))&&n<40899||63744<n&&n<64106?o+=-1!==(n=s.indexOf(i))?a.charAt(n):i:o+=i;return o}var k,S,E,A={s2t:function(e){return L(e,!0)},t2s:function(e){return L(e,!1)}};let B=!1;const I=(l,c,h,d,f,u)=>p(void 0,void 0,void 0,function*(){var t="yes"===w.getReaderConfig("isSliding");let e=document.getElementById("page-area");if(e){var r,i,n,s,o,a=e.getElementsByTagName("iframe")[0];if(a){let e=a.contentDocument;e&&(a=(a=Math.floor(l.clientWidth/12))%2==0?a:a-1,0<f?e.body.scrollBy({top:0,left:-l.offsetWidth-a,behavior:t?"smooth":"auto"}):f<0&&(r=l,i=c,n=h,s=d,o=u,yield p(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");var t;e&&(!(t=e.getElementsByTagName("iframe")[0])||(t=t.contentDocument)&&Math.abs(r.scrollHeight-r.scrollTop-r.clientHeight)<10&&Math.abs(t.body.scrollWidth-t.body.scrollLeft-t.body.clientWidth)<10&&(yield F(r,i,n,s),o("rendered")))}),e.body.scrollBy({top:0,left:l.offsetWidth+a,behavior:t?"smooth":"auto"})))}}}),D=(e,t,r,i)=>{r=r.filter(e=>e.href),t=window._.findLastIndex(r,{index:e,href:t});return"prev"===i?r[t-1]:r[t+1]},R=(i,n,s,o)=>p(void 0,void 0,void 0,function*(){var e=w.getKookitConfig("chapterTitle"),t=parseInt(w.getKookitConfig("chapterDocIndex")||"0"),r=w.getKookitConfig("chapterHref")||"";if(0!==t&&e){let e=D(t,r,n,"prev");e&&(w.setKookitConfig("chapterTitle",e.title),w.setKookitConfig("chapterHref",e.href),w.setKookitConfig("chapterDocIndex",e.index.toString()),w.setKookitConfig("text","prevChapter"),yield N(e.index,e.title,e.href,s,i,o),e.href&&-1<e.href.indexOf("#")&&(yield M(i,o,"","",e.href)))}}),N=(i,n,s,o,a,l)=>p(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){let r=t.contentDocument;if(r){r.body.innerHTML="",r.body.scrollTo(0,0),r.body.innerHTML=o[i].text;let e=Array.from(r.getElementsByTagName("link"));e.forEach(e=>{e.onload=()=>{console.log("finished")}});let t=[];e.forEach(r=>{t.push(new Promise((e,t)=>{r.addEventListener("load",e)}))}),yield Promise.all(t),w.setKookitConfig("chapterTitle",n),w.setKookitConfig("chapterHref",s),w.setKookitConfig("chapterDocIndex",i.toString()),w.setKookitConfig("percentage",i/o.length+""),((t,r)=>{let i=document.getElementById("page-area");if(i){let e=i.getElementsByTagName("iframe")[0];var n;e&&("scroll"===r?(n=e.contentDocument)&&(r=n.body,n=n.documentElement,e.height=2*Math.max(r.scrollHeight,r.offsetHeight,n.clientHeight,n.scrollHeight,n.offsetHeight)+"px",setTimeout(()=>{let e=document.getElementById("page-area");if(e){let i=e.getElementsByTagName("iframe")[0];if(i){var n=i.contentDocument;if(n){let e=n.body;var s=e.lastElementChild,o=e.lastChild,a=e.getElementsByTagName("a"),l=e.getElementsByTagName("p"),c=e.getElementsByTagName("img"),h=e.getElementsByTagName("div"),n=a[a.length-1],a=l[l.length-1],c=l[c.length-1],h=h[h.length-1];let t=a||n||c||h;window._.isElement(n)&&window._.isElement(a)&&window._.isElement(h)&&(t=n.clientHeight+n.offsetTop>a.clientHeight+a.offsetTop?n:a,h.clientHeight+h.offsetTop>t.clientHeight+t.offsetTop&&(t=h)),window._.isElement(c)&&c.clientHeight+c.offsetTop>t.clientHeight+t.offsetTop&&(t=c);let r=0;if((s||t||o)&&(3!==o.nodeType||s||t)){if(3===o.nodeType&&document.createRange){let e=document.createRange();e.selectNodeContents(o),!e.getBoundingClientRect||(c=e.getBoundingClientRect())&&(r=c.bottom-c.top)}o=Math.max(window._.isElement(s)?s.clientHeight+s.offsetTop:0,window._.isElement(o)?o.clientHeight+o.offsetTop:0,window._.isElement(t)?t.clientHeight+t.offsetTop:0)+400+(3===o.nodeType?r:0);i.height=o+"px"}}}}},500)):e.height=t.offsetHeight+"px")}})(a,l),((i,n)=>{let e=document.getElementById("page-area");if(e){var s=e.getElementsByTagName("iframe")[0];if(s){let r=s.contentDocument;if(r){var o,s=Math.floor(i.clientWidth/12),a=s%2==0?s:s-1;let e,t;for(o of r.getElementsByTagName("img")){var l=o.parentElement;e=0,t=0,o.width&&o.height?o.height/o.width>l.clientHeight/l.clientWidth?(e=l.clientHeight,t=e*o.width/o.height):(t=l.clientWidth,e=t*o.height/o.width):e=l&&l.clientWidth&&0<l.clientWidth?(t=l.clientWidth,l.clientHeight):(t=i.offsetWidth,i.offsetHeight),t=Math.min("scroll"===n||"single"===n?i.offsetWidth:(i.offsetWidth-a)/2,t),(t||e)&&o.setAttribute("style",`max-width: ${0<t?t:""}px;max-height:${0<e?e:""}px`)}}}}})(a,l)}}}}),M=(o,a,l,c,h)=>p(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){let n=t.contentDocument;if(n){let t=0,r=0,i=n.body;if(l){let e=d(n.body);var s=e.filter((e,t)=>f(e.textContent)&&(f(e.textContent)===f(l)||f(e.textContent)===A.t2s(f(l))||f(e.textContent)===A.s2t(f(l)))&&Math.abs(t-parseInt(c))<2);i=s[0],r=i?i.getBoundingClientRect().left:"prevChapter"===l?n.body.scrollWidth:0,t=i?i.getBoundingClientRect().top:0}else h&&-1<h.indexOf("#")&&(s=h.split("#").reverse()[0],i=O(n.body.querySelector("#"+s)||n.body,o),console.log(i),r=i?i.offsetLeft:0,t=i?i.offsetTop:0);"scroll"!==a?n.body.scrollTo(r,0):o.scrollTo(0,t)}}}}),O=(e,t)=>{var r=Math.floor(t.clientWidth/12),r=r%2==0?r:r-1;return parseInt(e.offsetLeft)%((parseInt(t.clientWidth)+r)/2)==0?e:O(e.parentElement,t)},H=(s,o)=>p(void 0,void 0,void 0,function*(){if(!B){let e=document.getElementById("page-area");if(e){var i=e.getElementsByTagName("iframe")[0];if(i){i=i.contentDocument;if(i){let t=d(i.body);var n=t.filter(e=>$(s,e,o)&&(e.textContent||"").trim())[0];let r=0;for(let e=0;e<t.length;e++)if($(s,t[e],o)&&n&&t[e].innerHTML===n.innerHTML){r=e;break}w.setKookitConfig("text",n&&n.textContent||""),w.setKookitConfig("count",r+""),B=!0,setTimeout(()=>{B=!1},100)}}}}}),F=(i,n,s,o)=>p(void 0,void 0,void 0,function*(){var e=parseInt(w.getKookitConfig("chapterDocIndex")||"0"),t=w.getKookitConfig("chapterHref")||"";let r=D(e,t,n,"next");r&&(w.setKookitConfig("chapterTitle",r.title),w.setKookitConfig("chapterHref",r.href),w.setKookitConfig("chapterDocIndex",r.index.toString()),w.setKookitConfig("text",""),yield N(r.index,r.title,r.href,s,i,o),r.href&&-1<r.href.indexOf("#")&&(yield M(i,o,"","",r.href)))}),$=(e,t,r)=>{var i,n=!1,s=t.getBoundingClientRect();return"scroll"!==r&&t.textContent&&t.textContent.trim()?n=-10<(i=s.left)&&i<=e.offsetWidth:t.textContent&&t.textContent.trim()?n=(t=s.top)>=e.scrollTop&&t<=e.scrollTop+e.offsetHeight:"scroll"!==r&&(n=0<=(s=s.left)&&s<=e.offsetWidth),n};E="undefined"==typeof Node?(k=1,S=3,4):(k=Node.ELEMENT_NODE,S=Node.TEXT_NODE,Node.CDATA_SECTION_NODE);var P=class{constructor(e,t){this.opts=Object.assign({flattenRange:!1,stricter:!0},t||{}),this.cfi=e;var r,i,n,t=new RegExp(/^epubcfi\((.*)\)$/),t=(e=e.trim()).match(t);if(!t)throw new Error("Not a valid CFI");if(!(t.length<2)){e=t[1],this.parts=[];for(var s=[],o=0;e.length;){if({parsed:r,offset:i,newDoc:n}=this.parse(e),!r||null===i)throw new Error("Parsing failed");if(o&&n)throw new Error("CFI is a range that spans multiple documents. This is not allowed");s.push(r),(n||e.length-i<=0)&&(2===o?this.to=s:this.parts.push(s),s=[]),","===(e=e.slice(i))[0]&&(0===o?(s.length&&this.parts.push(s),s=[]):1===o&&(s.length&&(this.from=s),s=[]),e=e.slice(1),o++)}this.from&&this.from.length&&(!this.opts.flattenRange&&this.to&&this.to.length?this.isRange=!0:(this.parts=this.parts.concat(this.from),delete this.from,delete this.to)),this.opts.stricter&&this.removeIllegalOpts()}}removeIllegalOpts(e){if(!e)if(this.from){if(this.removeIllegalOpts(this.from),!this.to)return;e=this.to}else e=this.parts;for(var t,r,i,n=0;n<e.length;n++)for(r=e[n],t=0;t<r.length-1;t++)delete(i=r[t]).temporal,delete i.spatial,delete i.offset,delete i.textLocationAssertion}static generatePart(e,t,r){for(var i,n="",s="spine"===e.parentNode.nodeName;e.parentNode&&(i=function(e,t,r){for(var i,n,s=0,o=0,a=!0,l=0;l<e.length;l++)if((n=e[l]).nodeType===k){if(i||a?(s+=2,a=!1):s++,t===n)return"img"===n.tagName.toLowerCase()?{count:s,offset:r}:{count:s};i=!(o=0)}else if(n.nodeType===S||n.nodeType===E){if((i||a)&&(s++,a=!1),t===n)return{count:s,offset:r+o};o+=n.textContent.length,i=!1}throw new Error("The specified node was not found in the array of siblings")}(e.parentNode.childNodes,e,t),!n&&i.offset&&(n=":"+i.offset),n="/"+i.count+(e.id?"["+e.id.replace(/[\[\]\^,();]/g,"^$&")+"]":"")+n,e=e.parentNode,!s||"package"!==e.nodeName););return n}static generate(e,t,r){var i;if(e instanceof Array){var n,s=[];for(n of e)s.push(this.generatePart(n.node,n.offset));i=s.join("!")}else i=this.generatePart(e,t,r);return r&&(i+=r),"epubcfi("+i+")"}static toParsed(e){return"string"==typeof e&&(cif=new this(e)),e.isRange?e.getFrom():e.get()}static comparePath(e,t){for(var r,i,n=Math.max(e.length,t.length),s=0;s<n;s++){if(r=e[s],i=t[s],!r)return-1;if(!i)return 1;if(i=this.compareParts(r,i))return i}return 0}static sort(e){e.sort((e,t)=>this.compare(e,t))}static compare(e,t){var r=e.get(),i=t.get();if(e.isRange||t.isRange){if(e.isRange&&t.isRange){var n=this.comparePath(r.from,i.from);return n?n:this.comparePath(r.to,i.to)}return e.isRange&&(r=r.from),t.isRange&&(i=i.from),this.comparePath(r,i)}return this.comparePath(r,i)}static compareParts(e,t){for(var r,i,n,s,o,a,l,c=Math.max(e.length,t.length),h=0;h<c;h++){if(r=e[h],i=t[h],!r)return-1;if(!i)return 1;if(n=r.nodeIndex-i.nodeIndex)return n;if(0===r.nodeIndex)return 0;if(!(h<c-1)){if(r.nodeIndex%2==0){if(s=r.temporal,o=i.temporal,l=a=void 0,l="number"==typeof o,n=(a="number"==typeof s)||l?!a&&l?-1:a&&!l?1:(s||0)-(o||0):0)return n;if(n=function(e,t){if(!e&&!t)return 0;if(!e&&t)return-1;if(e&&!t)return 1;var r=(e.y||0)-(t.y||0);return r||(e.x||0)-(t.x||0)}(r.spatial,i.spatial))return n}if(n=(r.offset||0)-(i.offset||0))return n}}return 0}decodeEntities(e,t){try{const r=e.createElement("textarea");return r.innerHTML=t,r.value}catch(e){return t}}trueLength(e,t){return this.decodeEntities(e,t).length}getFrom(){if(!this.isRange)throw new Error("Trying to get beginning of non-range CFI");if(!this.from)return this.deepClone(this.parts);const e=this.deepClone(this.parts);return e[e.length-1]=e[e.length-1].concat(this.from),e}getTo(){if(!this.isRange)throw new Error("Trying to get end of non-range CFI");const e=this.deepClone(this.parts);return e[e.length-1]=e[e.length-1].concat(this.to),e}get(){return this.isRange?{from:this.getFrom(),to:this.getTo(),isRange:!0}:this.deepClone(this.parts)}parseSideBias(e,t){var r;t&&(!(r=t.trim().match(/^(.*);s=([ba])$/))||r.length<3?"object"==typeof e.textLocationAssertion?e.textLocationAssertion.post=t:e.textLocationAssertion=t:(r[1]&&("object"==typeof e.textLocationAssertion?e.textLocationAssertion.post=r[1]:e.textLocationAssertion=r[1]),"a"===r[2]?e.sideBias="after":e.sideBias="before"))}parseSpatialRange(e){if(e){e=e.trim().match(/^([\d\.]+):([\d\.]+)$/);if(e&&!(e.length<3)){e={x:parseInt(e[1]),y:parseInt(e[2])};if("number"==typeof e.x&&"number"==typeof e.y)return e}}}parse(e){for(var t,r,i,n,s,o={},a=new RegExp(/[\d]/),l=!1,c=!1,h=0;h<=e.length;h++)if("^"!==(n=h<e.length?e[h]:"")||s){if("/"===r){if(n.match(a)){t?t+=n:t=n,s=!1;continue}t&&(o.nodeIndex=parseInt(t),t=null),i=r,r=null}if(":"===r){if(n.match(a)){t?t+=n:t=n,s=!1;continue}t&&(o.offset=parseInt(t),t=null),i=r,r=null}if("@"===r){let e=!1;if(n.match(a)||"."===n||":"===n?":"===n&&(l?e=!0:l=!0):e=!0,!e){t?t+=n:t=n,s=!1;continue}i=r,r=null,t&&l&&(o.spatial=this.parseSpatialRange(t)),t=null}if("~"===r){if(n.match(a)||"."===n){t?t+=n:t=n,s=!1;continue}t&&(o.temporal=parseFloat(t)),i=r,t=r=null}if(!r){if("!"===n){h++,r=n;break}if(","===n)break;if("/"===n){if(c)break;i=r,r=n,s=!(c=!0);continue}if(":"===n||"~"===n||"@"===n){if(this.opts.stricter){if(":"===n&&(void 0!==o.temporal||void 0!==o.spatial))break;if(("~"===n||"@"===n)&&void 0!==o.offset)break}i=r,r=n,l=s=!1;continue}if("["===n&&!s&&":"===i){i=r,s=!(r="[");continue}if("["===n&&!s&&"/"===i){i=r,s=!(r="nodeID");continue}}s=("["!==r?"nodeID"!==r||("]"!==n||s?t?t+=n:t=n:(i=r,r=null,o.nodeID=t,t=null)):"]"!==n||s?","!==n||s?t?t+=n:t=n:(o.textLocationAssertion={},t&&(o.textLocationAssertion.pre=t),t=null):(i=r,r=null,this.parseSideBias(o,t),t=null),!1)}else s=!0;if(!o.nodeIndex&&0!==o.nodeIndex)throw new Error("Missing child node index in CFI");return{parsed:o,offset:h,newDoc:"!"===r}}getChildNodeByCFIIndex(e,t,r,i){var n=t.childNodes;if(!n.length)return{node:t,offset:0};if(r<=0)return{node:n[0],relativeToNode:"before",offset:0};for(var s,o,a=0,l=0;l<n.length;l++)switch((o=n[l]).nodeType){case k:if(a%2==0){if(r<=(a+=2))return"img"===o.tagName.toLowerCase()&&i?{node:o,offset:i}:{node:o,offset:0}}else{if((a+=1)===r)return"img"===o.tagName.toLowerCase()&&i?{node:o,offset:i}:{node:o,offset:0};if(r<a)return s?{node:s,offset:this.trueLength(e,s.textContent)}:{node:t,offset:0}}s=o;break;case S:case E:if(0!==a&&a%2!=0||(a+=1),a===r){var c=this.trueLength(e,o.textContent);if(!(c<=i))return{node:o,offset:i};i-=c}s=o;break;default:continue}if(a<r){var h={relativeToNode:"after",offset:0};return h.node=s||t,this.isTextNode(h.node)&&(h.offset=this.trueLength(e,h.node.textContent.length)),h}}isTextNode(e){return!!e&&(e.nodeType===S||e.nodeType===E)}correctOffset(e,t,r,i){var n,s=t;if(n="string"==typeof i?this.decodeEntities(e,i):(i.pre=this.decodeEntities(e,i.pre),i.post=this.decodeEntities(e,i.post),i.pre+"."+i.post),!this.isTextNode(t))return{node:t,offset:0};for(;this.isTextNode(s.previousSibling);)s=s.previousSibling;var o,a=s;const l=[];for(var c="",h=0;this.isTextNode(s)&&(o=this.decodeEntities(e,s.textContent),l[h]=o.length,c+=o,s.nextSibling);)s=s.nextSibling,h++;i=i.pre?i.pre.length:0,i=function(e,t,r){r=r||0;for(var i,n=[],s=0;(i=e.match(t))&&(n.push(i.index+r),(s+=i.index+i.length)<(e=e.slice(i.index+i.length)).length););return n}(c,new RegExp(n),i);if(!i.length)return{node:t,offset:r};var d=function(e,t){for(var r,i,n=0;n<e.length;n++)i=Math.abs(e[n]-t),(!n||i<void 0)&&(i=void 0,r=e[n]);return r}(i,r);if(s===t&&d===r)return{node:t,offset:r};for(h=0,s=a;d>=l[h];){if((d-=l[h])<0)return{node:t,offset:r};if(!s.nextSibling||h+1>=nodeOffsets.length)return{node:t,offset:r};h++,s=s.nextSibling}return{node:s,offset:d}}resolveNode(e,t,r,i){if(i=Object.assign({},i||{}),!r)throw new Error("Missing DOM argument");var n;if(!(n=0===e?r.querySelector("package"):n))for(var s of r.childNodes)if(s.nodeType===k){n=s;break}if(!n)throw new Error("Document incompatible with CFIs");for(var o,a=n,l=0,c=t.length-1;0<=c;c--)if(o=t[c],!i.ignoreIDs&&o.nodeID&&(a=r.getElementById(o.nodeID))){l=c+1;break}var h={node:a=a||n,offset:0};for(c=l;c<t.length;c++)o=t[c],h=this.getChildNodeByCFIIndex(r,h.node,o.nodeIndex,o.offset),o.textLocationAssertion&&(h=this.correctOffset(r,h.node,o.offset,o.textLocationAssertion));return h}resolveURI(e,t,r){if(r=r||{},e<0||e>this.parts.length-2)throw new Error("index is out of bounds");var i=this.parts[e];if(!i)throw new Error("Missing CFI part for index: "+e);e=this.resolveNode(e,i,t,r).node,i=e.tagName.toLowerCase();if("itemref"===i&&"spine"===e.parentNode.tagName.toLowerCase()){r=e.getAttribute("idref");if(!r)throw new Error("Referenced node had not 'idref' attribute");if(!(e=t.getElementById(r)))throw new Error("Specified node is missing from manifest");r=e.getAttribute("href");if(!r)throw new Error("Manifest item is missing href attribute");return r}if("iframe"===i||"embed"===i){var n=e.getAttribute("src");if(!n)throw new Error(i+" element is missing 'src' attribute");return n}if("object"===i){n=e.getAttribute("data");if(!n)throw new Error(i+" element is missing 'data' attribute");return n}if("image"!==i&&"use"!==i)throw new Error("No URI found");e=e.getAttribute("xlink:href");if(!e)throw new Error(i+" element is missing 'xlink:href' attribute");return e}deepClone(e){return JSON.parse(JSON.stringify(e))}resolveLocation(e,t){var r=t.length-1,t=t[r];if(!t)throw new Error("Missing CFI part for index: "+r);e=this.resolveNode(r,t,e),t=this.deepClone(t[t.length-1]);return delete t.nodeIndex,t.offset||delete e.offset,Object.assign(t,e),t}resolveLast(e,t){if(t=Object.assign({range:!1},t||{}),!this.isRange)return this.resolveLocation(e,this.parts);if(t.range){const r=e.createRange();t=this.getFrom();"before"===t.relativeToNode?r.setStartBefore(t.node,t.offset):"after"===t.relativeToNode?r.setStartAfter(t.node,t.offset):r.setStart(t.node,t.offset);t=this.getTo();return"before"===t.relativeToNode?r.setEndBefore(t.node,t.offset):"after"===t.relativeToNode?r.setEndAfter(t.node,t.offset):r.setEnd(t.node,t.offset),r}return{from:this.resolveLocation(e,this.getFrom()),to:this.resolveLocation(e,this.getTo()),isRange:!0}}async fetchAndParse(i){return new Promise((e,t)=>{const r=new XMLHttpRequest;r.open("GET",i),r.responseType="document",r.onload=function(){r.readyState===r.DONE&&(r.status<200||300<=r.status?t(new Error("Failed to get: "+i)):e(r.responseXML))},r.onerror=function(){t(new Error("Failed to get: "+i))},r.send()})}async resolve(e,t,r){if("function"!=typeof t&&(r=t,t=null),!t){if("undefined"==typeof XMLHttpRequest)throw new Error("XMLHttpRequest not available. You must supply a function as the second argument.");t=this.fetchAndParse}var i,n,s;for("string"==typeof e?s=e:i=e,n=0;n<this.parts.length-1;n++)s&&(i=await t(s)),s=this.resolveURI(n,i,r);return s&&(i=await t(s)),this.resolveLast(i,r)}};class U extends class{constructor(){this.callbacks={},this.callbacks.base={}}on(e,t){const r=this;if(void 0===e||""===e)return console.warn("wrong names"),!1;if(void 0===t)return console.warn("wrong callback"),!1;const i=this.resolveNames(e);return i.forEach(function(e){e=r.resolveName(e);r.callbacks[e.namespace]instanceof Object||(r.callbacks[e.namespace]={}),r.callbacks[e.namespace][e.value]instanceof Array||(r.callbacks[e.namespace][e.value]=[]),r.callbacks[e.namespace][e.value].push(t)}),this}off(e){const i=this;if(void 0===e||""===e)return console.warn("wrong name"),!1;const t=this.resolveNames(e);return t.forEach(function(e){var t=i.resolveName(e);if("base"!==t.namespace&&""===t.value)delete i.callbacks[t.namespace];else if("base"===t.namespace)for(const r in i.callbacks)i.callbacks[r]instanceof Object&&i.callbacks[r][t.value]instanceof Array&&(delete i.callbacks[r][t.value],0===Object.keys(i.callbacks[r]).length&&delete i.callbacks[r]);else i.callbacks[t.namespace]instanceof Object&&i.callbacks[t.namespace][t.value]instanceof Array&&(delete i.callbacks[t.namespace][t.value],0===Object.keys(i.callbacks[t.namespace]).length&&delete i.callbacks[t.namespace])}),this}trigger(e,t=[]){if(void 0===e||""===e)return console.warn("wrong name"),!1;const r=this;const i=t instanceof Array?t:[];let n=this.resolveNames(e);n=this.resolveName(n[0]),setTimeout(()=>{if("base"===n.namespace)for(const e in r.callbacks){if(r.callbacks[e]instanceof Object&&r.callbacks[e][n.value]instanceof Array&&r.callbacks[e][n.value])r.callbacks[e][n.value].forEach(function(e){e.apply(r,i)});else if(this.callbacks[n.namespace]instanceof Object&&r.callbacks[n.namespace][n.value]){if(""===n.value)return console.warn("wrong name"),this;r.callbacks[n.namespace][n.value].forEach(function(e){e.apply(r,i)})}return null}},100)}resolveNames(e){let t=e;return t=t.replace(/[^a-zA-Z0-9 ,/.]/g,""),t=t.replace(/[,/]+/g," "),t=t.split(" "),t}resolveName(e){const t={};var r=e.split(".");return t.original=e,t.value=r[0],t.namespace="base",1<r.length&&""!==r[1]&&(t.namespace=r[1]),t}}{constructor(e){super(),this.mode=e,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}getPageSize(){return{width:this.element.clientWidth,height:this.element.clientHeight}}flatChapter(t){let r=[];for(let e=0;e<t.length;e++)t[e].subitems&&0<t[e].subitems.length?(r.push(t[e]),r=r.concat(this.flatChapter(t[e].subitems))):r.push(t[e]);return r}getChapter(){return this.chapterList}goToChapter(e,t,r){return p(this,void 0,void 0,function*(){yield N(parseInt(e),r,t,this.chapterDocList,this.element,this.mode),t&&-1<t.indexOf("#")&&(yield M(this.element,this.mode,"","",t)),yield this.record(),this.trigger("rendered")})}goToPosition(a){return p(this,void 0,void 0,function*(){let{text:e,chapterDocIndex:t,chapterTitle:r,chapterHref:i,count:n}=JSON.parse(a);if(r&&!t&&(t=window._.findLastIndex(this.chapterDocList,{title:r})),yield N(t,r,i,this.chapterDocList,this.element,this.mode),JSON.parse(a).cfi){let e=new P(JSON.parse(a).cfi),t=document.getElementById("page-area");if(!t)return;var s=t.getElementsByTagName("iframe")[0];if(!s)return;let r=s.contentDocument;if(!r)return;var o=e.resolveLast(r,{ignoreIDs:!0}),s=O(o.node.parentElement,this.element);console.log(s);o=s?s.offsetLeft:0,s=s?s.offsetTop:0;"scroll"!==this.mode?r.body.scrollTo(o,0):this.element.scrollTo(0,s)}else yield M(this.element,this.mode,e,n,"");yield this.record(),this.trigger("rendered")})}goToAnchor(e){return p(this,void 0,void 0,function*(){yield M(this.element,this.mode,"","",e),yield this.record(),this.trigger("rendered")})}removeContent(){this.element.innerHTML=""}prev(){return p(this,void 0,void 0,function*(){this.trigger("page-changed");let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){let e=t.contentDocument;e&&("scroll"===this.mode||0===e.body.scrollLeft?(yield R(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode),e.body.scrollTo(e.body.scrollWidth,0),this.trigger("rendered")):yield I(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,1,this.trigger),"yes"===w.getReaderConfig("isSliding")&&(yield new Promise(e=>setTimeout(e,1e3))),yield H(this.element,this.mode))}}})}next(){return p(this,void 0,void 0,function*(){this.trigger("page-changed");let e=document.getElementById("page-area");var t;e&&(!(t=e.getElementsByTagName("iframe")[0])||(t=t.contentDocument)&&(Math.abs(t.body.scrollWidth-t.body.scrollLeft-t.body.clientWidth)<10||"scroll"===this.mode?(yield F(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode),this.trigger("rendered")):yield I(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,-1,this.trigger),"yes"===w.getReaderConfig("isSliding")&&(yield new Promise(e=>setTimeout(e,1e3))),yield H(this.element,this.mode)))})}prevChapter(){return p(this,void 0,void 0,function*(){this.trigger("page-changed");let e=document.getElementById("page-area");var t;!e||(t=e.getElementsByTagName("iframe")[0])&&t.contentDocument&&(yield R(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode),yield this.record(),this.trigger("rendered"))})}nextChapter(){return p(this,void 0,void 0,function*(){this.trigger("page-changed");let e=document.getElementById("page-area");var t;!e||(t=e.getElementsByTagName("iframe")[0])&&t.contentDocument&&(yield F(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode),yield this.record(),this.trigger("rendered"))})}visibleText(){return((r,i)=>{let e=document.getElementById("page-area");if(e){var n=e.getElementsByTagName("iframe")[0];if(n){n=n.contentDocument;if(n){let e=d(n.body),t=e.filter(e=>$(r,e,i)&&(e.textContent||"").trim());return("scroll"!==i?t:e).map(e=>e.textContent).join(" ")}}}})(this.element,this.mode)}doSearch(e){return((i,n)=>{let s=[];for(let r=0;r<n.length;r++){var e=(new DOMParser).parseFromString(n[r].text,"text/html");let t=d(e.body);for(let e=0;e<t.length;e++)-1<(t[e].textContent||"").indexOf(i)&&s.push({excerpt:t[e].textContent||"",cfi:JSON.stringify({text:t[e].textContent,chapterTitle:n[r].title,chapterDocIndex:r,chapterHref:n[r].href,count:e,percentage:r/n.length})})}return s})(e,this.chapterDocList)}getProgress(){return p(this,void 0,void 0,function*(){return yield p(void 0,void 0,void 0,function*(){let e=document.getElementById("page-area");if(e){var t=e.getElementsByTagName("iframe")[0];if(t){t=t.contentDocument;if(t)return 1===parseInt(t.body.scrollWidth/t.body.clientWidth+"")&&(yield new Promise(e=>setTimeout(e,1e3))),{totalPage:parseInt(t.body.scrollWidth/t.body.clientWidth+"")+1,currentPage:parseInt(t.body.scrollLeft/t.body.clientWidth+"")+1}}}})})}record(){return p(this,void 0,void 0,function*(){"yes"===w.getReaderConfig("isSliding")&&(yield new Promise(e=>setTimeout(e,1e3))),yield H(this.element,this.mode)})}getPosition(){return{text:w.getKookitConfig("text"),chapterTitle:w.getKookitConfig("chapterTitle"),chapterDocIndex:w.getKookitConfig("chapterDocIndex"),chapterHref:w.getKookitConfig("chapterHref"),count:w.getKookitConfig("count"),percentage:w.getKookitConfig("percentage")}}setStyle(t){let e=document.getElementById("page-area");if(e){var r=e.getElementsByTagName("iframe")[0];if(r){let e=r.contentDocument;e&&e.body.setAttribute("style",t+e.body.getAttribute("style"))}}}}class z{constructor(e){this.book=e,this.chapterList=[],this.flattenChapters=[],this.chapterDocList=[]}getChapter(e){return p(this,void 0,void 0,function*(){return this.chapterList=e?yield Promise.all(e.map(t=>p(this,void 0,void 0,function*(){var e=t.href&&(yield this.book.resolveHref(t.href))?(yield this.book.resolveHref(t.href)).index:-1;return{title:t.label||e,href:t.href,index:e,subitems:t.subitems?yield this.getChapter(t.subitems):[]}}))):yield Promise.all(this.book.sections.map((e,t)=>p(this,void 0,void 0,function*(){return{title:e.label||t,href:e.href||"",index:t,subitems:e.subitems?yield this.getChapter(e.subitems):[]}}))),this.flattenChapters=this.flatChapter(this.chapterList),this.chapterList})}getChapterDoc(){return p(this,void 0,void 0,function*(){let e=yield Promise.all(this.book.sections.map(e=>p(this,void 0,void 0,function*(){return e.load?(yield fetch(yield e.load()).then(e=>e.blob())).text():""})));const r=this.flattenChapters.map(e=>e.index);return e.map(e=>o(e)).map((e,t)=>-1<r.indexOf(t)?{title:this.flattenChapters[r.indexOf(t)].title,href:this.flattenChapters[r.indexOf(t)].href,text:e}:{title:"",href:"",text:e})})}flatChapter(t){let r=[];for(let e=0;e<t.length;e++)t[e].subitems&&0<t[e].subitems.length?(r.push(t[e]),r=r.concat(this.flatChapter(t[e].subitems))):r.push(t[e]);return r}getMetadata(){return new Promise((i,e)=>p(this,void 0,void 0,function*(){const t=this.book.metadata;try{var e=yield this.book.getCover(),r=new FileReader;r.readAsDataURL(e),r.onloadend=()=>{i({name:t.title,author:t.author[0].name,description:t.description,publisher:t.publisher,cover:r.result})}}catch(e){i({name:t.title,author:t.author[0].name||t.author[0],description:t.description,publisher:t.publisher,cover:""})}}))}}const j=(e,i)=>e.map((e,t,r)=>i(e,t,r)?t:null).filter(e=>null!=e),W=(i,e)=>[-1,...e,i.length].reduce(({xs:e,a:t},r)=>({xs:e?.concat([i.slice(t+1,r)])??[],a:r}),{}).xs,X=(e,t)=>e.slice(0,-1).concat([e[e.length-1].concat(t[0])]).concat(t.slice(1)),q=/\d/,K=/^epubcfi\((.*)\)$/,G=e=>e.replace(/[\^[\](),;=]/g,"^$&"),Z=e=>K.test(e)?e:`epubcfi(${e})`,_=(e,t)=>j(e,([e])=>e===t),J=e=>{const t=[];let r;for(var[i,n]of e){if("/"===i)t.push({index:n});else{const s=t[t.length-1];if(":"===i)s.offset=n;else if("~"===i)s.temporal=n;else if("@"===i)s.spatial=(s.spatial??[]).concat(n);else if(";s"===i)s.side=n;else if("["===i){if("/"!==r||!n){s.text=(s.text??[]).concat(n);continue}s.id=n}}r=i}return t},V=e=>W(e,_(e,"!")).map(J),Y=e=>{var t=(e=>{const t=[];let r,i,n="";var s=e=>(t.push(e),r=null,n=""),o=e=>(n+=e,i=!1);for(const a of Array.from(e.trim()).concat(""))if("^"!==a||i){if("!"===r)s(["!"]);else if(","===r)s([","]);else if("/"===r||":"===r){if(q.test(a)){o(a);continue}s([r,parseInt(n)])}else if("~"===r){if(q.test(a)||"."===a){o(a);continue}s(["~",parseFloat(n)])}else if("@"===r){if(":"===a){s(["@",parseFloat(n)]),r="@";continue}if(q.test(a)||"."===a){o(a);continue}s(["@",parseFloat(n)])}else{if("["===r){";"!==a||i?","!==a||i?"]"!==a||i?o(a):s(["[",n]):(s(["[",n]),r="["):(s(["[",n]),r=";");continue}if(r?.startsWith(";")){"="!==a||i?";"!==a||i?"]"!==a||i?o(a):s([r,n]):(s([r,n]),r=";"):(r=`;${n}`,n="");continue}}"/"!==a&&":"!==a&&"~"!==a&&"@"!==a&&"["!==a&&"!"!==a&&","!==a||(r=a)}else i=!0;return t})((r=e).match(K)?.[1]??r),e=_(t,",");if(!e.length)return V(t);var[r,t,e]=W(t,e).map(V);return{parent:r,start:t,end:e}},Q=({index:e,id:t,offset:r,temporal:i,spatial:n,text:s,side:o})=>{var a=o?`;s=${o}`:"";return`/${e}`+(t?`[${G(t)}${a}]`:"")+(null!=r&&e%2?`:${r}`:"")+(i?`~${i}`:"")+(n?`@${n.join(":")}`:"")+(s||!t&&o?"["+(s?.map(G)?.join(",")??"")+a+"]":"")},ee=e=>e.parent?[e.parent,e.start,e.end].map(ee).join(","):e.map(e=>e.map(Q).join("")).join("!"),te=e=>Z(ee(e)),re=(e,t)=>"string"==typeof e?te(re(Y(e),t)):e.parent?X(e.parent,e[t?"end":"start"]):e,ie=({nodeType:e})=>3===e||4===e,ne=({nodeType:e})=>1===e,se=e=>{const t=Array.from(e.childNodes).filter(e=>ie(e)||ne(e)).reduce((e,t)=>{let r=e[e.length-1];return r?ie(t)?Array.isArray(r)?r.push(t):ie(r)?e[e.length-1]=[r,t]:e.push(t):ne(r)?e.push(null,t):e.push(t):e.push(t),e},[]);return ne(t[0])&&t.unshift("first"),ne(t[t.length-1])&&t.push("last"),t.unshift("before"),t.push("after"),t},oe=(e,t)=>e?se(e)[t]:null,ae=(e,t)=>{var r,i=t[t.length-1]["id"];if(i){i=e.ownerDocument.getElementById(i);if(i)return{node:i,offset:0}}for({index:r}of t){var n=oe(e,r);if("first"===n)return{node:e.firstChild??e};if("last"===n)return{node:e.lastChild??e};if("before"===n)return{node:e,before:!0};if("after"===n)return{node:e,after:!0};e=n}var s=t[t.length-1]["offset"];if(!Array.isArray(e))return{node:e,offset:s};let o=0;for(const l of e){var a=l.nodeValue["length"];if(o+a>=s)return{node:l,offset:s-o};o+=a}},le=(t,r)=>{var{parentNode:e,id:i}=t;const n=se(e);var s=n.findIndex(e=>Array.isArray(e)?e.some(e=>e===t):e===t),o=n[s];if(Array.isArray(o)){let e=0;for(const a of o){if(a===t){e+=r;break}e+=a.nodeValue.length}r=e}s={id:i,index:s,offset:r};return e!==t.ownerDocument.documentElement?le(e).concat(s):[s]},ce=(e,t)=>ae(e.documentElement,re(t)).node,he={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",DCTERMS:"http://purl.org/dc/terms/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},de={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},fe=e=>e.toLowerCase().replace(/[-:](.)/g,(e,t)=>t.toUpperCase()),ue=e=>e?e.trim().replace(/\s{2,}/g," "):"",pe=(t,r,e)=>e?e=>e.getAttribute(t)?.split(/\s/)?.includes(r):"function"==typeof r?e=>r(e.getAttribute(t)):e=>e.getAttribute(t)===r,me=(...e)=>t=>t?Object.fromEntries(e.map(e=>[fe(e),t.getAttribute(e)])):null,ge=e=>ue(e?.textContent),be=(e,r)=>{e=e.lookupNamespaceURI(null)===r||e.lookupPrefix(r);const i=e?(e,t)=>e=>e.namespaceURI===r&&e.localName===t:(e,t)=>e=>e.localName===t;return{$:(e,t)=>[...e.children].find(i(e,t)),$$:(e,t)=>[...e.children].filter(i(e,t)),$$$:e?(e,t)=>[...e.getElementsByTagNameNS(r,t)]:(e,t)=>[...e.getElementsByTagName(r,t)]}},ye=(t,e)=>{try{if(e.includes(":"))return new URL(t,e);var r="whatever:///";return decodeURI(new URL(t,r+e).href.replace(r,""))}catch(e){return console.warn(e),t}},ve=e=>/^(?!blob)\w+:/i.test(e),we=async(e,t,r)=>{const i=[];e.replace(t,(...e)=>(i.push(e),null));const n=[];for(const s of i)n.push(await r(...s));return e.replace(t,()=>n.shift())},xe=e=>e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&");var Te={attrs:["dir","xml:lang"]},Ce={name:"alternate-script",many:!0,...Te,props:["file-as"]},x={many:!0,...Te,props:[{name:"role",many:!0,attrs:["scheme"]},"file-as",Ce]};const Le=[{name:"title",many:!0,...Te,props:["title-type","display-seq","file-as",Ce]},{name:"identifier",many:!0,props:[{name:"identifier-type",attrs:["scheme"]}]},{name:"language",many:!0},{name:"creator",...x},{name:"contributor",...x},{name:"publisher",...Te,props:["file-as",Ce]},{name:"description",...Te,props:[Ce]},{name:"rights",...Te,props:[Ce]},{name:"date"},{name:"dcterms:modified",type:"meta"},{name:"subject",many:!0,...Te,props:["term","authority",Ce]},{name:"belongs-to-collection",type:"meta",many:!0,...Te,props:["collection-type","group-position","dcterms:identifier","file-as",Ce,{name:"belongs-to-collection",recursive:!0}]}],ke=(e,s=e=>e)=>{const{$:o,$$:r,$$$:t}=be(e,he.XHTML),i=n=>e=>{const t=o(e,"a")??o(e,"span");var r=o(e,"ol"),e=(e=t?.getAttribute("href"))?decodeURI(s(e)):null;const i={label:ge(t)||t?.getAttribute("title"),href:e,subitems:a(r)};return n&&(i.type=t?.getAttributeNS(he.EPUB,"type")?.split(/\s/)),i},a=(e,t)=>e?r(e,"li").map(i(t)):null;var n=(e,t)=>a(o(e,"ol"),t);let l=null,c=null,h=null,d=[];for(const f of t(e,"nav")){const u=f.getAttributeNS(he.EPUB,"type")?.split(/\s/)??[];u.includes("toc")?l??=n(f):u.includes("page-list")?c??=n(f):u.includes("landmarks")?h??=n(f,!0):d.push({label:ge(f.firstElementChild),type:u,list:n(f)})}return{toc:l,pageList:c,landmarks:h,others:d}},Se=(r,s=e=>e)=>{const{$:o,$$:a}=be(r,he.NCX),l=e=>{var t=o(e,"navLabel");const r=o(e,"content");var i=ge(t),t=(t=r.getAttribute("src"))?decodeURI(s(t)):null;if("navPoint"!==e.localName)return{label:i,href:t};{const n=a(e,"navPoint");return{label:i,href:t,subitems:n.length?n.map(l):null}}},i=(e,t)=>a(e,t).map(l);var e=(e,t)=>{e=o(r.documentElement,e);return e?i(e,t):null};return{toc:e("navMap","navPoint"),pageList:e("pageList","pageTarget"),others:a(r.documentElement,"navList").map(e=>({label:ge(o(e,"navLabel")),list:i(e,"navTarget")}))}},Ee=e=>{if(e){var t=e.split(":").map(e=>parseFloat(e));if(3===t.length){var[r,i,n]=t;return 60*r*60+60*i+n}if(2===t.length){var[t,s]=t;return 60*t+s}var[s,e]=e.split(/(?=[^\d.])/);return parseFloat(s)*("h"===e?3600:"min"===e?60:"ms"===e?.001:1)}},Ae=(e,i=e=>e)=>{const{$:n,$$$:t}=be(e,he.SMIL);return t(e,"par").map(e=>{var t=n(e,"text")?.getAttribute("src")?.split("#")?.[1];const r=n(e,"audio");return r?{id:t,audio:{src:(e=r.getAttribute("src"))?decodeURI(i(e)):null,clipBegin:Ee(r.getAttribute("clipBegin")),clipEnd:Ee(r.getAttribute("clipEnd"))}}:{id:t}})},Be=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,Ie=e=>ge(e.getElementById(e.documentElement.getAttribute("unique-identifier"))??e.getElementsByTagNameNS(he.DC,"identifier")[0]),De=async(e,t,r)=>{const i=new Uint8Array(await r.slice(0,t).arrayBuffer());t=Math.min(t,i.length);for(var n=0;n<t;n++)i[n]=i[n]^e[n%e.length];return new Blob([i,r.slice(t)],{type:r.type})},Re=(t=async e=>{e=(new TextEncoder).encode(e),e=await globalThis.crypto.subtle.digest("SHA-1",e);return new Uint8Array(e)})=>({"http://www.idpf.org/2008/embedding":{key:e=>t(Ie(e).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(e,t)=>De(e,1040,t)},"http://ns.adobe.com/pdf/enc#RC":{key:e=>{const r=(e=>{for(const r of e.getElementsByTagNameNS(he.DC,"identifier")){var[t]=ge(r).split(":").slice(-1);if(Be.test(t))return t}return""})(e).replaceAll("-","");return Uint8Array.from({length:16},(e,t)=>parseInt(r.slice(2*t,2*t+2),16))},decode:(e,t)=>De(e,1024,t)}});class Ne{#uris=new Map;#decoders=new Map;#algorithms;constructor(e){this.#algorithms=e}async init(e,t){var r,i;if(e)for({algorithm:r,uri:i}of Array.from(e.getElementsByTagNameNS(he.ENC,"EncryptedData"),e=>({algorithm:e.getElementsByTagNameNS(he.ENC,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:e.getElementsByTagNameNS(he.ENC,"CipherReference")[0]?.getAttribute("URI")}))){if(!this.#decoders.has(r)){const n=this.#algorithms[r];if(!n){console.warn("Unknown encryption algorithm");continue}const s=await n.key(t);this.#decoders.set(r,e=>n.decode(s,e))}this.#uris.set(i,r)}}getDecoder(e){return this.#decoders.get(this.#uris.get(e))??(e=>e)}}class Me{constructor({opf:e,resolveHref:i}){this.opf=e;const{$:t,$$:r,$$$:n}=be(e,he.OPF);var s=t(e.documentElement,"manifest");const o=t(e.documentElement,"spine"),a=r(o,"itemref");this.manifest=r(s,"item").map(me("href","id","media-type","properties","media-overlay")).map(e=>(e.href=i(e.href),e.properties=e.properties?.split(/\s/),e)),this.spine=a.map(me("idref","id","linear","properties")).map(e=>(e.properties=e.properties?.split(/\s/),e)),this.pageProgressionDirection=o.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(o.getAttribute("toc"))??this.manifest.find(e=>e.mediaType===de.NCX))?.href;s=t(e.documentElement,"guide");s&&(this.guide=r(s,"reference").map(me("type","title","href")).map(({type:e,title:t,href:r})=>({label:t,type:e.split(/\s/),href:i(r)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(n(e,"meta").find(pe("name","cover"))?.getAttribute("content"))??this.getItemByHref(this.guide?.find(e=>e.type.includes("cover"))?.href),this.cfis=(e=>{const t=[];var r,i,n=e[0]["parentNode"];const s=le(n);for([r,i]of se(n).entries()){var o=e[t.length];i===o&&t.push(te([s.concat({id:o.id,index:r})]))}return t})(a)}getItemByID(t){return this.manifest.find(e=>e.id===t)}getItemByHref(t){return this.manifest.find(e=>e.href===t)}getItemByProperty(t){return this.manifest.find(e=>e.properties?.includes(t))}resolveCFI(e){const t=Y(e),r=(t.parent??t).shift();let i=ce(this.opf,r);i&&"idref"!==i.nodeName&&(r.at(-1).id=null,i=ce(this.opf,r));const n=i?.getAttribute("idref");return{index:this.spine.findIndex(e=>e.idref===n),anchor:e=>((e,t)=>{var r=re(t),i=re(t,!0),t=e.documentElement,r=ae(t,r[0]),i=ae(t,i[0]);const n=e.createRange();return r.before?n.setStartBefore(r.node):r.after?n.setStartAfter(r.node):n.setStart(r.node,r.offset),i.before?n.setEndBefore(i.node):i.after?n.setEndAfter(i.node):n.setEnd(i.node,i.offset),n})(e,t)}}}class Oe{#cache=new Map;#children=new Map;#refCount=new Map;allowScript=!1;constructor({loadText:e,loadBlob:t,resources:r}){this.loadText=e,this.loadBlob=t,this.manifest=r.manifest,this.assets=r.manifest}createURL(e,t,r,i){if(!t)return"";r=URL.createObjectURL(new Blob([t],{type:r}));if(this.#cache.set(e,r),this.#refCount.set(e,1),i){const n=this.#children.get(i);n?n.push(e):this.#children.set(i,[e])}return r}ref(e,t){const r=this.#children.get(t);return r?.includes(e)||(this.#refCount.set(e,this.#refCount.get(e)+1),r?r.push(e):this.#children.set(t,[e])),this.#cache.get(e)}unref(e){if(this.#refCount.has(e)){var t=this.#refCount.get(e)-1;if(t<1){URL.revokeObjectURL(this.#cache.get(e)),this.#cache.delete(e),this.#refCount.delete(e);const r=this.#children.get(e);if(r)for(;r.length;)this.unref(r.pop());this.#children.delete(e)}else this.#refCount.set(e,t)}}async loadItem(e,t=[]){if(!e)return null;const{href:r,mediaType:i}=e;var n=de.JS.test(e.mediaType);if(n&&!this.allowScript)return null;var s=t.at(-1);return this.#cache.has(r)?this.ref(r,s):(n||[de.XHTML,de.HTML,de.CSS,de.SVG].includes(i))&&t.every(e=>e!==r)?this.loadReplaced(e,t):this.createURL(r,await this.loadBlob(r),i,s)}async loadHref(e,t,r=[]){if(ve(e))return e;const i=ye(e,t);var n=this.manifest.find(e=>e.href===i);return n?this.loadItem(n,r.concat(t)):e}async loadReplaced(e,n=[]){const{href:s,mediaType:r}=e;var i,o=n.at(-1),a=await this.loadText(s);if(!a)return null;if([de.XHTML,de.HTML,de.SVG].includes(r)){let t=(new DOMParser).parseFromString(a,r);if(r===de.XHTML&&t.querySelector("parsererror")&&(e.mediaType=de.HTML,t=(new DOMParser).parseFromString(a,e.mediaType)),[de.XHTML,de.SVG].includes(e.mediaType)){let e=t.firstChild;for(;e instanceof ProcessingInstruction;)e.data&&(i=await we(e.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(e,t,r,i)=>this.loadHref(r,s,n).then(e=>`${t}${e}${i}`)),e.replaceWith(t.createProcessingInstruction(e.target,i))),e=e.nextSibling}var l=async(e,t)=>e.setAttribute(t,await this.loadHref(e.getAttribute(t),s,n));for(const h of t.querySelectorAll("link[href]"))await l(h,"href");for(const d of t.querySelectorAll("[src]"))await l(d,"src");for(const f of t.querySelectorAll("[poster]"))await l(f,"poster");for(const u of t.querySelectorAll("object[data]"))await l(u,"data");for(const p of t.querySelectorAll("[*|href]:not([href]"))p.setAttributeNS(he.XLINK,"href",await this.loadHref(p.getAttributeNS(he.XLINK,"href"),s,n));for(const m of t.querySelectorAll("style"))m.textContent&&(m.textContent=await this.replaceCSS(m.textContent,s,n));for(const g of t.querySelectorAll("[style]"))g.setAttribute("style",await this.replaceCSS(g.getAttribute("style"),s,n));const c=(new XMLSerializer).serializeToString(t);return this.createURL(s,c,e.mediaType,o)}const c=r===de.CSS?await this.replaceCSS(a,s,n):await this.replaceString(a,s,n);return this.createURL(s,c,r,o)}async replaceCSS(e,r,i=[]){e=await we(e,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(e,t)=>this.loadHref(t,r,i).then(e=>`url("${e}")`));const t=await we(e,/@import\s*["']([^"'\n]*?)["']/gi,(e,t)=>this.loadHref(t,r,i).then(e=>`@import "${e}"`)),n=window?.innerWidth??800,s=window?.innerHeight??600,o=t.replace(/(\d*\.?\d+)vw/g,(e,t)=>parseFloat(t)*n/100+"px").replace(/(\d*\.?\d+)vh/g,(e,t)=>parseFloat(t)*s/100+"px");return o.replaceAll("-epub-","")}replaceString(e,o,t=[]){const a=new Map,r=this.assets.map(e=>{if(e.href!==o){var t=((e,t)=>{if(!e)return t;const r=e.replace(/\/$/,"").split("/"),i=t.replace(/\/$/,"").split("/");t=(r.length>i.length?r:i).findIndex((e,t)=>r[t]!==i[t]);return t<0?"":Array(r.length-t).fill("..").concat(i.slice(t)).join("/")})(o.slice(0,o.lastIndexOf("/")+1),e.href),r=encodeURI(t),i="/"+e.href,n=encodeURI(i),n=new Set([t,r,i,n]);for(const s of n)a.set(s,e);return Array.from(n)}}).flat().filter(e=>e);if(!r.length)return e;var i=new RegExp(r.map(xe).join("|"),"g");return we(e,i,async e=>this.loadItem(a.get(e.replace(/^\//,"")),t.concat(o)))}unloadItem(e){this.unref(e?.href)}}class He{parser=new DOMParser;#encryption;constructor({loadText:e,loadBlob:t,getSize:r,sha1:i}){this.loadText=e,this.loadBlob=t,this.getSize=r,this.#encryption=new Ne(Re(i))}#parseXML(e){return e?this.parser.parseFromString(e,de.XML):null}async#loadXML(e){return this.#parseXML(await this.loadText(e))}async init(){const e=await this.#loadXML("META-INF/container.xml");if(!e)throw new Error("Failed to load container file");var t=Array.from(e.getElementsByTagNameNS(he.CONTAINER,"rootfile"),me("full-path","media-type")).filter(e=>"application/oebps-package+xml"===e.mediaType);if(!t.length)throw new Error("No package document defined in container");const r=t[0].fullPath;var i=await this.#loadXML(r);if(!i)throw new Error("Failed to load package document");t=await this.#loadXML("META-INF/encryption.xml");await this.#encryption.init(t,i),this.resources=new Me({opf:i,resolveHref:e=>ye(e,r)});const s=new Oe({loadText:this.loadText,loadBlob:e=>Promise.resolve(this.loadBlob(e)).then(this.#encryption.getDecoder(e)),resources:this.resources});this.sections=this.resources.spine.map((e,t)=>{var{idref:r,linear:i,properties:e=[]}=e;const n=this.resources.getItemByID(r);return n?{id:this.resources.getItemByID(r)?.href,load:()=>s.loadItem(n),unload:()=>s.unloadItem(n),createDocument:()=>this.loadDocument(n),size:this.getSize(n.href),cfi:this.resources.cfis[t],linear:i,pageSpread:(e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}})(e),resolveHref:e=>ye(e,n.href),loadMediaOverlay:()=>this.loadMediaOverlay(n)}:(console.warn(`Could not find item with ID "${r}" in manifest`),null)}).filter(e=>e);const{navPath:n,ncxPath:o}=this.resources;if(n)try{var a=ke(await this.#loadXML(n),e=>ye(e,n));this.toc=a.toc,this.pageList=a.pageList,this.landmarks=a.landmarks}catch(e){console.warn(e)}if(!this.toc&&o)try{var l=Se(await this.#loadXML(o),e=>ye(e,o));this.toc=l.toc,this.pageList=l.pageList}catch(e){console.warn(e)}this.landmarks??=this.resources.guide;const{metadata:c,rendition:h,media:d}=(e=>{const{$:t,$$:r}=be(e,he.OPF),i=t(e.documentElement,"metadata"),s=Array.from(i.children),l=(o,t)=>{if(!t)return null;const{props:e=[],attrs:r=[]}=o,i=ge(t);if(!e.length&&!r.length)return i;var n=t.getAttribute("id");const a=n?s.filter(pe("refines","#"+n)):[];return Object.fromEntries([["value",i]].concat(e.map(e=>{var{many:t,recursive:r}=e,i="string"==typeof e?e:e.name,n=pe("property",i);const s=r?o:e;return[fe(i),t?a.filter(n).map(e=>l(s,e)):l(s,a.find(n))]})).concat(r.map(e=>[fe(e),t.getAttribute(e)])))},o=s.filter(pe("refines",null));e=t=>Object.fromEntries(r(i,"meta").filter(pe("property",e=>e?.startsWith(t))).map(e=>[e.getAttribute("property").replace(t,""),ge(e)]));return{metadata:Object.fromEntries(Le.map(t=>{const{type:e,name:r,many:i}=t;var n="meta"===e?e=>e.namespaceURI===he.OPF&&e.getAttribute("property")===r:e=>e.namespaceURI===he.DC&&e.localName===r;return[fe(r),i?o.filter(n).map(e=>l(t,e)):l(t,o.find(n))]})),rendition:e("rendition:"),media:e("media:")}})(i);this.rendition=h,this.media=d,d.duration=Ee(d.duration),this.dir=this.resources.pageProgressionDirection,this.rawMetadata=c;l=c?.title?.[0];this.metadata={title:l?.value,sortAs:l?.fileAs,language:c?.language,identifier:Ie(i),description:c?.description?.value,publisher:c?.publisher?.value,published:c?.date,modified:c?.dctermsModified,subject:c?.subject?.filter(({value:e,code:t})=>e||t)?.map(({value:e,code:t,scheme:r})=>({name:e,code:t,scheme:r})),rights:c?.rights?.value};const f={art:"artist",aut:"author",bkp:"producer",clr:"colorist",edt:"editor",ill:"illustrator",trl:"translator",pbl:"publisher"};i=r=>e=>{var t=[...new Set(e.role?.map(({value:e,scheme:t})=>(t&&"marc:relators"!==t?null:f[e])??r))],e={name:e.value,sortAs:e.fileAs};return[t.length?t:[r],e]};return c?.creator?.map(i("author"))?.concat(c?.contributor?.map?.(i("contributor")))?.forEach(([e,t])=>e.forEach(e=>{this.metadata[e]?this.metadata[e].push(t):this.metadata[e]=[t]})),this}async loadDocument(e){var t=await this.loadText(e.href);return this.parser.parseFromString(t,e.mediaType)}async loadMediaOverlay(e){e=e.mediaOverlay;if(!e)return null;const t=this.resources.getItemByID(e);e=await this.#loadXML(t.href);return Ae(e,e=>ye(e,t.href))}resolveCFI(e){return this.resources.resolveCFI(e)}resolveHref(e){const[t,r]=e.split("#"),i=this.resources.getItemByHref(decodeURI(t));return i?{index:this.resources.spine.findIndex(({idref:e})=>e===i.id),anchor:r?e=>((e,t)=>e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`))(e,r):()=>0}:null}splitTOCHref(e){return e?.split("#")??[]}getTOCFragment(e,t){return e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`)}isExternal(e){return ve(e)}async getCover(){var e=this.resources?.cover;return e?.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){const e=await this.loadText("META-INF/calibre_bookmarks.txt");var t="encoding=json+base64:";if(e?.startsWith(t)){t=atob(e.slice(t.length));return JSON.parse(t)}}}const Fe=e=>{if(!e)return"";const t=document.createElement("textarea");return t.innerHTML=e,t.value},$e={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},Pe={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},Ue={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},ze={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},je={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},We={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},Xe={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},qe={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},Ke={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},Ge={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},Ze={magic:[0,4,"string"],numEntries:[8,4,"uint"]},_e={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},Je={1252:"windows-1252",65001:"utf-8"},Ve={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},Ye={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},Qe=(e,t)=>{const r=new e.constructor(e.length+t.length);return r.set(e),r.set(t,e.length),r},et=(e,t,r)=>{const i=new e.constructor(e.length+t.length+r.length);return i.set(e),i.set(t,e.length),i.set(r,e.length+t.length),i},tt=new TextDecoder,rt=e=>tt.decode(e),it=e=>{if(e){var t=e.byteLength,t=4===t?"getUint32":2===t?"getUint16":"getUint8";return new DataView(e)[t](0)}},nt=(e,n)=>Object.fromEntries(Array.from(Object.entries(e)).map(([e,[t,r,i]])=>[e,("string"===i?rt:it)(n.slice(t,t+r))])),st=e=>new TextDecoder(Je[e]),ot=(e,t=0)=>{let r=0,i=0;for(const n of e.subarray(t,t+4))if(r=r<<7|(127&n)>>>0,i++,128&n)break;return{value:r,length:i}},at=e=>{let t=0;for(;0<e;e>>=1)1==(1&e)&&t++;return t},lt=e=>{let t=0;for(;0==(1&e);)e>>=1,t++;return t},ct=t=>{let r=[];for(let e=0;e<t.length;e++){var i=t[e];if(0===i)r.push(0);else if(i<=8)for(const a of t.subarray(e+1,(e+=i)+1))r.push(a);else if(i<=127)r.push(i);else if(i<=191){var n=i<<8|t[1+e++],s=(16383&n)>>>3,o=3+(7&n);for(let e=0;e<o;e++)r.push(r[r.length-s])}else r.push(32,128^i)}return Uint8Array.from(r)},ht=async(t,r)=>{const i=await r(t.huffcdic),{magic:e,offset1:n,offset2:s}=nt(Ke,i);if("HUFF"!==e)throw new Error("Invalid HUFF record");const d=Array.from({length:256},(e,t)=>n+4*t).map(e=>it(i.slice(e,e+4))).map(e=>[128&e,31&e,e>>>8]),f=[null].concat(Array.from({length:32},(e,t)=>s+8*t).map(e=>[it(i.slice(e,e+4)),it(i.slice(e+4,e+8))])),u=[];for(let e=1;e<t.numHuffcdic;e++){const m=await r(t.huffcdic+e);var o=nt(Ge,m);if("CDIC"!==o.magic)throw new Error("Invalid CDIC record");var a=Math.min(1<<o.codeLength,o.numEntries-u.length);const g=m.slice(o.length);for(let e=0;e<a;e++){var l=it(g.slice(2*e,2*e+2)),c=it(g.slice(l,l+2)),h=32768&c,c=new Uint8Array(g.slice(l+2,l+2+(32767&c)));u.push([c,h])}}const p=o=>{let a=new Uint8Array;var l=8*o.byteLength;for(let s=0;s<l;){var c=Number(((t,r)=>{var e=r+32,i=e>>3;let n=0n;for(let e=r>>3;e<=i;e++)n=n<<8n|BigInt(t[e]??0);return n>>8n-BigInt(7&e)&0xffffffffn})(o,s));let[e,t,r]=d[c>>>24];if(!e){for(;c>>>32-t<f[t][0];)t+=1;r=f[t][1]}if((s+=t)>l)break;var h=r-(c>>>32-t);let[i,n]=u[h];n||(i=p(i),u[h]=[i,!0]),a=Qe(a,i)}return a};return p},dt=async(t,r)=>{const e=await r(t),i=nt(Xe,e);if("INDX"!==i.magic)throw new Error("Invalid INDX record");const n=st(i.encoding),s=e.slice(i.length);var o=nt(qe,s);if("TAGX"!==o.magic)throw new Error("Invalid TAGX section");var a=(o.length-12)/4,l=Array.from({length:a},(e,t)=>new Uint8Array(s.slice(12+4*t,12+4*t+4)));const c={};let h=0;for(let e=0;e<i.numCncx;e++){const H=await r(t+i.numRecords+e+1);var d=new Uint8Array(H);for(let e=0;e<d.byteLength;){var f=e,{value:u,length:p}=ot(d,e);e+=p;p=H.slice(e,e+u);e+=u,c[h+f]=n.decode(p)}h+=65536}const m=[];for(let e=0;e<i.numRecords;e++){const F=await r(t+1+e);var g=new Uint8Array(F);const i=nt(Xe,F);if("INDX"!==i.magic)throw new Error("Invalid INDX record");for(let r=0;r<i.numRecords;r++){var b=i.idxt+4+2*r,y=it(F.slice(b,b+2)),v=it(F.slice(y,y+1)),b=rt(F.slice(y+1,y+1+v));const $=[];var w,x,T,C,L,k,S,E,A,B,I,D=y+1+v;let e=0,t=D+o.numControlBytes;for([w,x,T,C]of l)1&C?e++:(S=D+e,(L=it(F.slice(S,S+1))&T)===T?1<at(T)?({value:k,length:S}=ot(g,t),$.push([w,null,k,x]),t+=S):$.push([w,1,null,x]):$.push([w,L>>lt(T),null,x]));const P={};for([E,A,B,I]of $){const U=[];if(null!=A)for(let e=0;e<A*I;e++){var{value:R,length:N}=ot(g,t);U.push(R),t+=N}else{let e=0;for(;e<B;){var{value:M,length:O}=ot(g,t);U.push(M),t+=O,e+=O}}P[E]=U}m.push({name:b,tagMap:P})}}return{table:m,cncx:c}};class ft extends class{#file;#offsets;pdb;async open(e){this.#file=e;var t=nt(Pe,await e.slice(0,78).arrayBuffer());this.pdb=t;const r=await e.slice(78,78+8*t.numRecords).arrayBuffer();this.#offsets=Array.from({length:t.numRecords},(e,t)=>it(r.slice(8*t,8*t+4))).map((e,t,r)=>[e,r[t+1]])}loadRecord(e){e=this.#offsets[e];if(!e)throw new RangeError("Record index out of bounds");return this.#file.slice(...e).arrayBuffer()}async loadMagic(e){e=this.#offsets[e][0];return rt(await this.#file.slice(e,e+4).arrayBuffer())}}{#start=0;#resourceStart;#decoder;#encoder;#decompress;#removeTrailingEntries;constructor({unzlib:e}){super(),this.unzlib=e}async open(e){await super.open(e),this.headers=this.#getHeaders(await super.loadRecord(0)),this.#resourceStart=this.headers.mobi.resourceStart;let t=8<=this.headers.mobi.version;if(!t){e=this.headers.exth?.boundary;if(e<4294967295)try{this.headers=this.#getHeaders(await super.loadRecord(e)),this.#start=e,t=!0}catch(e){console.warn(e),console.warn("Failed to open KF8; falling back to MOBI")}}return await this.#setup(),new(t?xt:mt)(this).init()}#getHeaders(e){var t=nt(Ue,e);const r=nt(ze,e);if("MOBI"!==r.magic)throw new Error("Missing MOBI header");var{titleOffset:i,titleLength:n,localeLanguage:s,localeRegion:o}=r;r.title=e.slice(i,i+n);s=Ye[s];r.language=s?.[o>>2]??s?.[0];s=64&r.exthFlag?((t,e)=>{var{magic:r,count:i}=nt(We,t);if("EXTH"!==r)throw new Error("Invalid EXTH header");const n=st(e),s={};let o=12;for(let e=0;e<i;e++){var a,l,c,h=it(t.slice(o,o+4)),d=it(t.slice(o+4,o+8));h in Ve&&([a,l,c]=Ve[h],h=t.slice(o+8,o+d),h="uint"===l?it(h):n.decode(h),c?(s[a]??=[],s[a].push(h)):s[a]=h),o+=d}return s})(e.slice(r.length+16),r.encoding):null,e=8<=r.version?nt(je,e):null;return{palmdoc:t,mobi:r,exth:s,kf8:e}}async#setup(){var{palmdoc:e,mobi:t}=this.headers;this.#decoder=st(t.encoding),this.#encoder=new TextEncoder;var e=e["compression"];if(this.#decompress=1===e?e=>e:2===e?ct:17480===e?await ht(t,this.loadRecord.bind(this)):null,!this.#decompress)throw new Error("Unknown compression type");var t=t["trailingFlags"];const i=1&t,n=at(t>>>1);this.#removeTrailingEntries=t=>{for(let e=0;e<n;e++){var r=(e=>{let t=0;for(const r of e.subarray(-4))128&r&&(t=0),t=t<<7|127&r;return t})(t);t=t.subarray(0,-r)}var e;return i&&(e=1+(3&t[t.length-1]),t=t.subarray(0,-e)),t}}decode(...e){return this.#decoder.decode(...e)}encode(...e){return this.#encoder.encode(...e)}loadRecord(e){return super.loadRecord(this.#start+e)}loadMagic(e){return super.loadMagic(this.#start+e)}loadText(e){return this.loadRecord(e+1).then(e=>new Uint8Array(e)).then(this.#removeTrailingEntries).then(this.#decompress)}async loadResource(e){const t=await super.loadRecord(this.#resourceStart+e);e=rt(t.slice(0,4));return"FONT"===e?(async(e,t)=>{var{flags:r,dataStart:i,keyLength:n,keyStart:s}=nt(_e,e);const o=new Uint8Array(e.slice(i));if(2&r)for(var i=16===n?1024:1040,a=new Uint8Array(e.slice(s,s+n)),l=Math.min(i,o.length),c=0;c<l;c++)o[c]=o[c]^a[c%a.length];if(1&r)try{return t(o)}catch(e){console.warn(e),console.warn("Failed to decompress font")}return o})(t,this.unzlib):"VIDE"===e||"AUDI"===e?t.slice(12):t}getNCX(){var e=this.headers.mobi.indx;if(e<4294967295)return(async(e,t)=>{const{table:r,cncx:i}=await dt(e,t),n=r.map(({tagMap:e},t)=>({index:t,offset:e[1]?.[0],size:e[2]?.[0],label:i[e[3]]??"",headingLevel:e[4]?.[0],pos:e[6],parent:e[21]?.[0],firstChild:e[22]?.[0],lastChild:e[23]?.[0]})),s=t=>(null==t.firstChild||(t.children=n.filter(e=>e.parent===t.index).map(s)),t);return n.filter(e=>0===e.headingLevel).map(s)})(e,this.loadRecord.bind(this))}getMetadata(){const{mobi:e,exth:t}=this.headers;return{identifier:e.uid.toString(),title:Fe(t?.title||this.decode(e.title)),author:t?.creator?.map(Fe),publisher:Fe(t?.publisher),language:t?.language??e.language,published:t?.date,description:Fe(t?.description),subject:t?.subject?.map(Fe),rights:Fe(t?.rights)}}async getCover(){var e=this.headers["exth"],e=e?.coverOffset<4294967295?e?.coverOffset:e?.thumbnailOffset<4294967295?e?.thumbnailOffset:null;if(null!=e){e=await this.loadResource(e);return new Blob([e])}}}const ut=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,pt=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi;class mt{parser=new DOMParser;serializer=new XMLSerializer;#resourceCache=new Map;#textCache=new Map;#cache=new Map;#sections;#fileposList=[];#type=$e.HTML;constructor(e){this.mobi=e}async init(){let t=new Uint8Array;for(let e=0;e<this.mobi.headers.palmdoc.numTextRecords;e++)t=Qe(t,await this.mobi.loadText(e));const i=Array.from(new Uint8Array(t),e=>String.fromCharCode(e)).join("");this.#sections=[0].concat(Array.from(i.matchAll(ut),e=>e.index)).map((e,t,r)=>i.slice(e,r[t+1])).map(e=>Uint8Array.from(e,e=>e.charCodeAt(0))).map(e=>({book:this,raw:e})).reduce((e,t)=>{var r=e[e.length-1];return t.start=r?.end??0,t.end=t.start+t.raw.byteLength,e.concat(t)},[]),this.sections=this.#sections.map((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start}));const n=[];try{const s=await this.mobi.getNCX(),o=({label:e,offset:t,children:r})=>{var i=t.toString().padStart(10,"0"),t=`filepos:${i}`;return n.push(i),{label:e=Fe(e),href:t,subitems:r?.map(o)}};if(this.toc=s?.map(o),this.landmarks=await this.getGuide(),!this.toc){var e=this.landmarks.find(({type:e})=>e?.includes("toc"))?.href;if(e){var r=this.resolveHref(e)["index"];const a=await this.sections[r].createDocument();this.toc=Array.from(a.querySelectorAll("a[filepos]"),e=>({label:e.innerText?.trim(),href:`filepos:${e.getAttribute("filepos")}`}))}}}catch(e){console.warn(e)}return this.#fileposList=[...new Set(n.concat(Array.from(i.matchAll(pt),e=>e[1])))].map(e=>({filepos:e,number:Number(e)})).sort((e,t)=>e.number-t.number),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const e=await this.createDocument(this.#sections[0]);return Array.from(e.getElementsByTagName("reference"),e=>({label:e.getAttribute("title"),type:e.getAttribute("type")?.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`}))}async loadResource(e){if(this.#resourceCache.has(e))return this.#resourceCache.get(e);var t=await this.mobi.loadResource(e),t=URL.createObjectURL(new Blob([t]));return this.#resourceCache.set(e,t),t}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(const s of e.querySelectorAll("img[recindex]")){var t=s.getAttribute("recindex");try{s.src=await this.loadRecindex(t)}catch(e){console.warn(`Failed to load image ${t}`)}}for(const o of e.querySelectorAll("[mediarecindex]")){var r=o.getAttribute("mediarecindex"),i=o.getAttribute("recindex");try{o.src=await this.loadRecindex(r),i&&(o.poster=await this.loadRecindex(i))}catch(e){console.warn(`Failed to load media ${r}`)}}for(const a of e.querySelectorAll("[filepos]")){var n=a.getAttribute("filepos");a.href=`filepos:${n}`}}async loadText(t){if(this.#textCache.has(t))return this.#textCache.get(t);const i=t["raw"],n=this.#fileposList.filter(({number:e})=>e>=t.start&&e<t.end).map(e=>({...e,offset:e.number-t.start}));let s=i;n.length&&(s=i.subarray(0,n[0].offset),n.forEach(({filepos:e,offset:t},r)=>{r=n[r+1],e=this.mobi.encode(`<a id="filepos${e}"></a>`);s=et(s,e,i.subarray(t,r?.offset))}));var e=this.mobi.decode(s).replaceAll(ut,"");return this.#textCache.set(t,e),e}async createDocument(e){e=await this.loadText(e);return this.parser.parseFromString(e,this.#type)}async loadSection(e){if(this.#cache.has(e))return this.#cache.get(e);const t=await this.createDocument(e),r=t.createElement("style");t.head.append(r),r.append(t.createTextNode(`blockquote {
            margin-block-start: 0;
            margin-block-end: 0;
            margin-inline-start: 1em;
            margin-inline-end: 0;
        }`)),await this.replaceResources(t);var i=this.serializer.serializeToString(t),i=URL.createObjectURL(new Blob([i],{type:this.#type}));return this.#cache.set(e,i),i}resolveHref(e){const t=e.match(/filepos:(.*)/)[1],r=Number(t);return{index:this.#sections.findIndex(e=>e.end>r),anchor:e=>e.getElementById(`filepos${t}`)}}splitTOCHref(e){e=e.match(/filepos:(.*)/)[1];const t=Number(e);return[this.#sections.findIndex(e=>e.end>t),`filepos${e}`]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}}const gt=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,bt=/kindle:pos:fid:(\w+):off:(\w+)/,yt=e=>{var[t,e]=e.match(bt).slice(1);return{fid:parseInt(t,32),off:parseInt(e,32)}},vt=(e=0,t=0)=>`kindle:pos:fid:${e.toString(32).toUpperCase().padStart(4,"0")}:off:${t.toString(32).toUpperCase().padStart(10,"0")}`,wt=e=>{var t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(t){var[,e,t]=t;return`[${e}="${CSS.escape(t)}"]`}};class xt{parser=new DOMParser;#cache=new Map;#fragmentOffsets=new Map;#fragmentSelectors=new Map;#tables={};#sections;#fullRawLength;#rawHead=new Uint8Array;#rawTail=new Uint8Array;#lastLoadedHead=-1;#lastLoadedTail=-1;#checkType=!0;#type=$e.XHTML;constructor(e){this.mobi=e}async init(){const e=this.mobi.loadRecord.bind(this.mobi);var t=this.mobi.headers["kf8"];try{const l=await e(t.fdst);var r=nt(Ze,l);if("FDST"!==r.magic)throw new Error("Missing FDST record");var i=Array.from({length:r.numEntries},(e,t)=>12+8*t).map(e=>[it(l.slice(e,e+4)),it(l.slice(e+4,e+8))]);this.#tables.fdstTable=i,this.#fullRawLength=i[i.length-1][1]}catch{}const n=(await dt(t.skel,e)).table.map(({name:e,tagMap:t},r)=>({index:r,name:e,numFrag:t[1][0],offset:t[6][0],length:t[6][1]})),s=await dt(t.frag,e),o=s.table.map(({name:e,tagMap:t})=>({insertOffset:parseInt(e),selector:s.cncx[t[2][0]],index:t[4][0],offset:t[6][0],length:t[6][1]}));this.#tables.skelTable=n,this.#tables.fragTable=o,this.#sections=n.reduce((e,t)=>{var r=e[e.length-1],i=r?.fragEnd??0,n=i+t.numFrag;const s=o.slice(i,n);i=t.length+s.map(e=>e.length).reduce((e,t)=>e+t);return e.concat({skel:t,frags:s,fragEnd:n,length:i,totalLength:(r?.totalLength??0)+i})},[]),this.#sections.unshift({frags:[]}),this.sections=this.#sections.map((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length}:{linear:"no"});try{const c=await this.mobi.getNCX(),h=({label:e,pos:t,children:r})=>{var[i,n]=t,t=vt(i,n);const s=this.#fragmentOffsets.get(i);return s?s.push(n):this.#fragmentOffsets.set(i,[n]),{label:Fe(e),href:t,subitems:r?.map(h)}};this.toc=c?.map(h),this.landmarks=await this.getGuide()}catch(e){console.warn(e)}const a=this.mobi.headers["exth"];return this.dir=a.pageProgressionDirection,this.rendition={layout:"true"===a.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(a.originalResolution?.split("x")?.slice(0,2)?.map((e,t)=>[t?"height":"width",e])??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(t){const r={};var i=this.mobi.headers.kf8.resourceStart,n=this.mobi.pdb.numRecords;for(let e=i;e<n;e++)try{const o=await this.mobi.loadMagic(e);var s=t.find(e=>e===o);s&&(r[s]=e)}catch{}return r}async getGuide(){var e=this.mobi.headers.kf8.guide;if(e<4294967295){var t=this.mobi.loadRecord.bind(this.mobi);const{table:r,cncx:i}=await dt(e,t);return r.map(({name:e,tagMap:t})=>({label:i[t[1][0]]??"",type:e?.split(/\s/),href:vt(t[6]?.[0]??t[3]?.[0])}))}}async loadResourceBlob(e){var{resourceType:t,id:r,type:e}=(e=>{var[t,r,e]=e.match(gt).slice(1);return{resourceType:t,id:parseInt(r,32),type:e}})(e),r="flow"===t?await this.loadFlow(r):await this.mobi.loadResource(r-1),r=[$e.XHTML,$e.HTML,$e.CSS,$e.SVG].includes(e)?await this.replaceResources(this.mobi.decode(r)):r;return new Blob([r],{type:e})}async loadResource(e){if(this.#cache.has(e))return this.#cache.get(e);var t=await this.loadResourceBlob(e),t=URL.createObjectURL(t);return this.#cache.set(e,t),t}replaceResources(e){return(async(e,t,r)=>{const i=[];e.replace(t,(...e)=>(i.push(e),null));const n=[];for(const s of i)n.push(await r(...s));return e.replace(t,()=>n.shift())})(e,new RegExp(gt,"g"),this.loadResource.bind(this))}async loadRaw(e,t){var r=t-this.#rawHead.length,i=null==this.#fullRawLength?1/0:this.#fullRawLength-this.#rawTail.length-e;if(r<0||r<i){for(;this.#rawHead.length<t;){var n=++this.#lastLoadedHead,n=await this.mobi.loadText(n);this.#rawHead=Qe(this.#rawHead,n)}return this.#rawHead.slice(e,t)}for(;this.#fullRawLength-this.#rawTail.length>e;){var s=this.mobi.headers.palmdoc.numTextRecords-1-++this.#lastLoadedTail,s=await this.mobi.loadText(s);this.#rawTail=Qe(s,this.#rawTail)}i=this.#fullRawLength-this.#rawTail.length;return this.#rawTail.slice(e-i,t-i)}loadFlow(e){if(e<4294967295)return this.loadRaw(...this.#tables.fdstTable[e])}async loadText(e){var{skel:t,frags:r,length:e}=e;const i=await this.loadRaw(t.offset,t.offset+e);let n=i.slice(0,t.length);for(const c of r){var s=c.insertOffset-t.offset,o=t.length+c.offset,a=i.slice(o,o+c.length);n=et(n.slice(0,s),a,n.slice(s));s=this.#fragmentOffsets.get(c.index);if(s)for(const h of s){var l=this.mobi.decode(a).slice(h),l=wt(l);this.#setFragmentSelector(c.index,h,l)}}return this.mobi.decode(n)}async createDocument(e){e=await this.loadText(e);return this.parser.parseFromString(e,this.#type)}async loadSection(e){if(this.#cache.has(e))return this.#cache.get(e);var t=await this.loadText(e);this.#checkType&&this.parser.parseFromString(t,this.#type).querySelector("parsererror")&&(this.#type=$e.HTML),this.#checkType&&(this.#checkType=!1);t=await this.replaceResources(t),t=URL.createObjectURL(new Blob([t],{type:this.#type}));return this.#cache.set(e,t),t}getIndexByFID(t){return this.#sections.findIndex(e=>e.frags.some(e=>e.index===t))}#setFragmentSelector(e,t,r){const i=this.#fragmentSelectors.get(e);if(i)i.set(t,r);else{const i=new Map;this.#fragmentSelectors.set(e,i),i.set(t,r)}}async resolveHref(e){const{fid:t,off:r}=yt(e);var i=this.getIndexByFID(t);if(!(i<0)){const s=this.#fragmentSelectors.get(t)?.get(r);if(s)return{index:i,anchor:e=>e.querySelector(s)};const{skel:o,frags:a}=this.#sections[i];var n=a.find(e=>e.index===t),e=o.offset+o.length+n.offset,n=await this.loadRaw(e,e+n.length),n=this.mobi.decode(n).slice(r);const l=wt(n);this.#setFragmentSelector(t,r,l);return{index:i,anchor:e=>e.querySelector(l)}}}splitTOCHref(e){e=yt(e);return[this.getIndexByFID(e.fid),e]}getTOCFragment(e,{fid:t,off:r}){r=this.#fragmentSelectors.get(t)?.get(r);return e.querySelector(r)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}}const Tt=({entries:e,loadBlob:i,getSize:t},r)=>{const n=new Map,s=new Map,o=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".svg"],a=e.map(e=>e.filename).filter(t=>o.some(e=>t.endsWith(e))).sort(),l={getCover:()=>i(a[0])};return l.metadata={title:r.name},l.sections=a.map(e=>({id:e,load:()=>(async e=>{if(n.has(e))return n.get(e);var t=URL.createObjectURL(await i(e)),r=URL.createObjectURL(new Blob([`<img src="${t}">`],{type:"text/html"}));return s.set(e,[t,r]),n.set(e,r),r})(e),unload:()=>(e=>{s.get(e)?.forEach?.(e=>URL.revokeObjectURL(e)),s.delete(e),n.delete(e)})(e),size:t(e)})),l.toc=a.map(e=>({label:e,href:e})),l.rendition={layout:"pre-paginated"},l.resolveHref=t=>({index:l.sections.findIndex(e=>e.id===t)}),l.splitTOCHref=e=>[e,null],l.getTOCFragment=e=>e.documentElement,l};const Ct=e=>e?.trim()?.replace(/\s{2,}/g," "),Lt=e=>Ct(e?.textContent),kt={XLINK:"http://www.w3.org/1999/xlink",EPUB:"http://www.idpf.org/2007/ops"},St={XML:"application/xml",XHTML:"application/xhtml+xml"},Et={strong:["strong","self"],emphasis:["em","self"],style:["span","self"],a:"anchor",strikethrough:["s","self"],sub:["sub","self"],sup:["sup","self"],code:["code","self"],image:"image"};const At={epigraph:["blockquote"],subtitle:["h2",Et],"text-author":["p",Et],date:["p",Et],stanza:"stanza"},Bt={title:["header",{p:["h1",Et],"empty-line":["br"]}],epigraph:["blockquote","self"],image:"image",annotation:["aside"],section:["section","self"],p:["p",Et],poem:["blockquote",At],subtitle:["h2",Et],cite:["blockquote","self"],"empty-line":["br"],table:["table",{tr:["tr",["align"]],th:["th",["colspan","rowspan","align","valign"]],td:["td",["colspan","rowspan","align","valign"]]}],"text-author":["p",Et]};At.epigraph.push(Bt);const It={image:"image",title:["section",{p:["h1",Et],"empty-line":["br"]}],epigraph:["section",Bt],section:["section",Bt]},Dt=e=>{const t=e.getAttributeNS(kt.XLINK,"href");var[,r]=t.split("#");const i=e.getRootNode().getElementById(r);return i?`data:${i.getAttribute("content-type")};base64,${i.textContent}`:t};class Rt{constructor(e){this.fb2=e,this.doc=document.implementation.createDocument(kt.XHTML,"html")}image(e){const t=this.doc.createElement("img");return t.alt=e.getAttribute("alt"),t.title=e.getAttribute("title"),t.setAttribute("src",Dt(e)),t}anchor(e){const t=this.convert(e,{a:["a",Et]});return t.setAttribute("href",e.getAttributeNS(kt.XLINK,"href")),"note"===e.getAttribute("type")&&t.setAttributeNS(kt.EPUB,"epub:type","noteref"),t}stanza(e){const t=this.convert(e,{stanza:["p",{title:["header",{p:["strong",Et],"empty-line":["br"]}],subtitle:["p",Et]}]});for(const r of e.children)"v"===r.nodeName&&(t.append(this.doc.createTextNode(r.textContent)),t.append(this.doc.createElement("br")));return t}convert(e,t){if(3===e.nodeType)return this.doc.createTextNode(e.textContent);if(4===e.nodeType)return this.doc.createCDATASection(e.textContent);if(8===e.nodeType)return this.doc.createComment(e.textContent);var r=t?.[e.nodeName];if(!r)return null;if("string"==typeof r)return this[r](e);var[i,r]=r;const n=this.doc.createElement(i);if(e.id&&(n.id=e.id),n.classList.add(e.nodeName),Array.isArray(r))for(const l of r)n.setAttribute(l,e.getAttribute(l));var s="self"===r?t:Array.isArray(r)?null:r;let o=e.firstChild;for(;o;){var a=this.convert(o,s);a&&n.append(a),o=o.nextSibling}return n}}const Nt=URL.createObjectURL(new Blob([`
@namespace epub "http://www.idpf.org/2007/ops";
body > img, section > img {
    display: block;
    margin: auto;
}
.title {
    text-align: center;
}
body > section > .title, body.notesBodyType > .title {
    margin: 3em 0;
}
body.notesBodyType > section .title {
    text-align: left;
    margin: 1em 0;
}
p {
    text-indent: 1em;
    margin: 0;
}
:not(p) + p, p:first-child {
    text-indent: 0;
}
.poem p {
    text-indent: 0;
    margin: 1em 0;
}
.text-author, .date {
    text-align: end;
}
.text-author:before {
    content: "—";
}
table {
    border-collapse: collapse;
}
td, th {
    padding: .25em;
}
a[epub|type~="noteref"] {
    font-size: .75em;
    vertical-align: super;
}
body:not(.notesBodyType) > .title, body:not(.notesBodyType) > .epigraph {
    margin: 3em 0;
}
`],{type:"text/css"})),Mt="data-foliate-id",Ot=async e=>{const t={},r=await(async e=>{var t=await e.arrayBuffer();const r=new TextDecoder("utf-8").decode(t),i=new DOMParser;e=i.parseFromString(r,St.XML);const n=e.xmlEncoding||r.match(/^<\?xml\s+version\s*=\s*["']1.\d+"\s+encoding\s*=\s*["']([A-Za-z0-9._-]*)["']/)?.[1];if(n&&"utf-8"!==n.toLowerCase()){const r=new TextDecoder(n).decode(t);return i.parseFromString(r,St.XML)}return e})(e),i=new Rt(r),n=e=>r.querySelector(e);var s=e=>[...r.querySelectorAll(e)],o=e=>{var t=Lt(e.querySelector("nickname"));if(t)return t;const r=Lt(e.querySelector("first-name")),i=Lt(e.querySelector("middle-name")),n=Lt(e.querySelector("last-name"));return{name:[r,i,n].filter(e=>e).join(" "),sortAs:n?[n,[r,i].filter(e=>e).join(" ")].join(", "):null}},a=e=>e?.getAttribute("value")??Lt(e),e=n("title-info annotation");t.metadata={title:Lt(n("title-info book-title")),identifier:Lt(n("document-info id")),language:Lt(n("title-info lang")),author:s("title-info author").map(o),translator:s("title-info translator").map(o),producer:s("document-info author").map(o).concat(s("document-info program-used").map(Lt)),publisher:Lt(n("publish-info publisher")),published:a(n("title-info date")),modified:a(n("document-info date")),description:e?i.convert(e,{annotation:["div",Bt]}).innerHTML:null,subject:s("title-info genre").map(Lt)},t.getCover=()=>fetch(Dt(n("coverpage image"))).then(e=>e.blob());const l=Array.from(r.querySelectorAll("body"),e=>{e=i.convert(e,{body:["body",It]});return[Array.from(e.children,e=>{var t=[e,...e.querySelectorAll("[id]")].map(e=>e.id);return{el:e,ids:t}}),e]}),c=l[0][0].map(({el:e,ids:t})=>{return{ids:t,titles:Array.from(e.querySelectorAll(":scope > section > .title"),(e,t)=>(e.setAttribute(Mt,t),{title:Lt(e),index:t})),el:e}}).concat(l.slice(1).map(([e,t])=>{e=e.map(e=>e.ids).flat();return t.classList.add("notesBodyType"),{ids:e,el:t,linear:"no"}})).map(({ids:e,titles:t,el:r,linear:i})=>{const n=(s=r.outerHTML,`<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head><link href="${Nt}" rel="stylesheet" type="text/css"/></head>
    <body>${s}</body>
</html>`);var s=new Blob([n],{type:St.XHTML});const o=URL.createObjectURL(s);return{ids:e,title:Ct(r.querySelector(".title, .subtitle, p")?.textContent??(r.classList.contains("title")?r.textContent:"")),titles:t,load:()=>o,createDocument:()=>(new DOMParser).parseFromString(n,St.XHTML),size:s.size-Array.from(r.querySelectorAll("[src]"),e=>e.getAttribute("src")?.length??0).reduce((e,t)=>e+t,0),linear:i}}),h=new Map;return t.sections=c.map((e,t)=>{var{ids:r,load:i,createDocument:n,size:s,linear:e}=e;for(const o of r)o&&h.set(o,t);return{id:t,load:i,createDocument:n,size:s,linear:e}}),t.toc=c.map(({title:e,titles:t},r)=>{const i=r.toString();return{label:e,href:i,subitems:t?.length?t.map(({title:e,index:t})=>({label:e,href:`${i}#${t}`})):null}}).filter(e=>e),t.resolveHref=e=>{const[t,r]=e.split("#");return t?{index:Number(t),anchor:e=>e.querySelector(`[${Mt}="${r}"]`)}:{index:h.get(r),anchor:e=>e.getElementById(r)}},t.splitTOCHref=e=>e?.split("#")?.map(e=>Number(e))??[],t.getTOCFragment=(e,t)=>e.querySelector(`[${Mt}="${t}"]`),t};window.e=window.eval,window.a=window.atob,e.ComicRender=class extends U{constructor(e,t,r){super(t),this.comicBuffer=e,this.mode=t,this.format=r,this.chapterList=[],this.chapterDocList=[],this.book="",this.element="",this.rpc}renderTo(s){return new Promise((n,e)=>p(this,void 0,void 0,function*(){var e,t,r=new Blob([this.comicBuffer]),r=new File([r],"book."+this.format.toLocaleLowerCase(),{lastModified:(new Date).getTime(),type:r.type});"CBZ"===this.format?(e=yield this.makeZipLoader(r),this.book=Tt(e,r)):"CBT"===this.format?(e=yield this.makeTarLoader(),this.book=Tt(e,r)):"CBR"===this.format?(this.rpc=yield window.RPC.new("/lib/libunrar/worker.js",{loaded:function(){console.log("loaded")},progressShow:function(e,t,r){console.log(r)}}),yield new Promise(e=>setTimeout(e,200)),t=yield this.makeRarLoader(),this.book=Tt(t,r)):"CB7"===this.format&&(t=yield this.make7zLoader(),this.book=Tt(t,r));let i=new z(this.book);this.element=s,this.chapterList=yield i.getChapter(this.book.toc),this.chapterDocList=yield i.getChapterDoc(),b(s),y(s,this.mode),this.trigger("rendered"),n()}))}makeZipLoader(c){return p(this,void 0,void 0,function*(){const{ZipReader:e,BlobReader:t,TextWriter:r,BlobWriter:i}=window.zip;window.zip.configure({useWebWorkers:!1});const n=new e(new t(c)),s=yield n.getEntries(),o=new Map(s.map(e=>[e.filename,e]));var a=r=>(e,...t)=>o.has(e)?r(o.get(e),...t):null,l=a(e=>e.getData(new r)),a=a((e,t)=>e.getData(new i(t)));return{entries:s,loadText:l,loadBlob:a,getSize:e=>{return null!==(e=null===(e=o.get(e))||void 0===e?void 0:e.uncompressedSize)&&void 0!==e?e:0}}})}makeTarLoader(){return p(this,void 0,void 0,function*(){const e=yield window.untar(this.comicBuffer),i=new Map(e.map(e=>[e.name,e]));var t=r=>(e,...t)=>i.has(e)?r(i.get(e),...t):null,r=t(e=>e.readAsString()),t=t((e,t)=>e.blob);return{entries:e.map(e=>({filename:e.name})),loadText:r,loadBlob:t,getSize:e=>{return null!==(e=null===(e=i.get(e))||void 0===e?void 0:e.size)&&void 0!==e?e:0}}})}makeRarLoader(){return p(this,void 0,void 0,function*(){return new Promise((n,e)=>{var t=[this.comicBuffer],r=[{name:"book.rar",content:this.comicBuffer}];this.rpc.transferables=t,this.rpc.unrar(r,null,0).then(e=>{var t=this.getRarEntries(e.ls);const i=new Map(Object.values(t).map(e=>[e.fullFileName,e]));var r=r=>(e,...t)=>i.has(e)?r(i.get(e),...t):null,e=r(e=>e.fullFileName),r=r((e,t)=>new Blob([e.fileContent]));n({entries:Object.values(t).map(e=>({filename:e.fullFileName})),loadText:e,loadBlob:r,getSize:e=>{return null!==(e=null===(e=i.get(e))||void 0===e?void 0:e.fileSize)&&void 0!==e?e:0}})}).catch(e=>{console.log(e)})})})}make7zLoader(){return p(this,void 0,void 0,function*(){var e="/lib/7z-wasm/7zz.wasm";if(!window.wasmBinary){const a=yield fetch(e,{credentials:"same-origin"});if(!a.ok)throw"failed to load wasm binary file at '"+e+"'";window.wasmBinary=yield a.arrayBuffer()}const t=yield window.SevenZip({wasmBinary:window.wasmBinary});var r=new Uint8Array(this.comicBuffer),i="archive.cb7",e=t.FS.open(i,"w+");t.FS.write(e,r,0,r.length),t.FS.close(e),t.callMain(["x",i]);const n=t.FS,s=this.get7zEntries(n.lookupPath("/").node),o=new Map(s.map(e=>[e.name,e]));e=r=>(e,...t)=>o.has(e)?r(o.get(e),...t):null,i=e(e=>e.name),e=e((e,t)=>new Blob([e.buffer]));return{entries:s.map(e=>({filename:e.name})),loadText:i,loadBlob:e,getSize:e=>{return null!==(e=null===(e=o.get(e))||void 0===e?void 0:e.packSize)&&void 0!==e?e:0}}})}getRarEntries(t){const e=Object.keys(t);let r=[];return e.forEach(e=>{"dir"===t[e].type?r=r.concat(this.getRarEntries(t[e].ls)):r.push({fullFileName:e,fileContent:t[e].fileContent,fileSize:t[e].fileSize})}),r}get7zEntries(e){const t=e.contents,r=Object.keys(t).filter(e=>"archive.cb7"!=e&&"dev"!=e&&"home"!=e&&"proc"!=e&&"tmp"!=e);let i=[];return r.forEach(e=>{t[e].isFolder?i=i.concat(this.get7zEntries(t[e])):i.push({name:e,buffer:t[e].contents,size:t[e].usedBytes})}),i}getMetadata(){return p(this,void 0,void 0,function*(){return new Promise((n,e)=>p(this,void 0,void 0,function*(){var e,t,r=new Blob([this.comicBuffer]),r=new File([r],"book",{lastModified:(new Date).getTime(),type:r.type});"CBZ"===this.format?(e=yield this.makeZipLoader(r),this.book=Tt(e,r)):"CBT"===this.format?(e=yield this.makeTarLoader(),this.book=Tt(e,r)):"CBR"===this.format?(this.rpc=yield window.RPC.new("/lib/libunrar/worker.js",{loaded:function(){console.log("loaded")},progressShow:function(e,t,r){console.log(r)}}),yield new Promise(e=>setTimeout(e,200)),t=yield this.makeRarLoader(),this.book=Tt(t,r)):"CB7"===this.format&&(t=yield this.make7zLoader(),this.book=Tt(t,r));var r=yield this.book.getCover(),i=new FileReader;i.readAsDataURL(r),i.onloadend=()=>{n({cover:i.result})}}))})}},e.EpubRender=class extends U{constructor(e,t){super(t),this.epubBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(i){return new Promise((r,e)=>p(this,void 0,void 0,function*(){var e=new Blob([this.epubBuffer]),e=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type}),e=yield this.makeZipLoader(e);this.book=yield new He(e).init();let t=new z(this.book);this.element=i,this.chapterList=yield t.getChapter(this.book.toc),this.chapterDocList=yield t.getChapterDoc(),b(i),y(i,this.mode),this.trigger("rendered"),r()}))}makeZipLoader(c){return p(this,void 0,void 0,function*(){const{ZipReader:e,BlobReader:t,TextWriter:r,BlobWriter:i}=window.zip;window.zip.configure({useWebWorkers:!1});const n=new e(new t(c)),s=yield n.getEntries(),o=new Map(s.map(e=>[e.filename,e]));var a=r=>(e,...t)=>o.has(e)?r(o.get(e),...t):null,l=a(e=>e.getData(new r)),a=a((e,t)=>e.getData(new i(t)));return{entries:s,loadText:l,loadBlob:a,getSize:e=>{return null!==(e=null===(e=o.get(e))||void 0===e?void 0:e.uncompressedSize)&&void 0!==e?e:0}}})}getMetadata(){return p(this,void 0,void 0,function*(){var e=new Blob([this.epubBuffer]),e=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type}),e=yield this.makeZipLoader(e);this.book=yield new He(e).init();let t=new z(this.book);return yield t.getMetadata()})}},e.Fb2Render=class extends U{constructor(e,t){super(t),this.fb2Buffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(i){return new Promise((r,e)=>p(this,void 0,void 0,function*(){var e=new Blob([this.fb2Buffer]);this.book=yield Ot(e);let t=new z(this.book);this.element=i,this.chapterList=yield t.getChapter(this.book.toc),this.chapterDocList=yield t.getChapterDoc(),b(i),y(i,this.mode),this.trigger("rendered"),r()}))}getMetadata(){return p(this,void 0,void 0,function*(){var e=new Blob([this.fb2Buffer]);this.book=yield Ot(e);let t=new z(this.book);return yield t.getMetadata()})}},e.MobiRender=class extends U{constructor(e,t){super(t),this.mobiBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(i){return new Promise((r,e)=>p(this,void 0,void 0,function*(){var t=new Blob([this.mobiBuffer]),t=new File([t],"book",{lastModified:(new Date).getTime(),type:t.type});if(yield(async e=>{return"BOOKMOBI"===rt(await e.slice(60,68).arrayBuffer())})(t)){this.book=yield new ft({unzlib:window.fflate.unzlibSync}).open(t);let e=new z(this.book);this.element=i,this.chapterList=yield e.getChapter(this.book.toc),this.chapterDocList=yield e.getChapterDoc(),this.metadata=yield e.getMetadata(),b(i),y(i,this.mode),this.trigger("rendered"),r()}}))}getMetadata(){return p(this,void 0,void 0,function*(){var e=new Blob([this.mobiBuffer]),e=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});this.book=yield new ft({unzlib:window.fflate.unzlibSync}).open(e);let t=new z(this.book);return yield t.getMetadata()})}},e.StrRender=class extends U{constructor(e,t){super(t),this.bookStr=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(r){return new Promise((t,e)=>p(this,void 0,void 0,function*(){this.element=r;let e=new v(this.bookStr);e.isContainChapter()||(this.bookStr=g(e.getDocText()),e=new v(this.bookStr)),this.chapterList=e.getChapter(),this.chapterDocList=e.getChapterDoc(),b(r),y(r,this.mode),this.trigger("rendered"),t()}))}},e.TxtRender=class extends U{constructor(e,t,r){super(t),this.txtBuffer=e,this.encoding=r,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element=""}renderTo(i){return new Promise((r,e)=>p(this,void 0,void 0,function*(){var e=new TextDecoder(this.encoding).decode(this.txtBuffer),e=g(e);this.bookStr=e,this.element=i;let t=new v(this.bookStr);this.chapterList=t.getChapter(),this.chapterDocList=t.getChapterDoc(),b(i),y(i,this.mode),this.trigger("rendered"),r()}))}},Object.defineProperty(e,"__esModule",{value:!0})});
